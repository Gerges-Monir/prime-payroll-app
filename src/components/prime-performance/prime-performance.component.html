<div class="animate-fade-in space-y-8">
  <div>
    <h2 class="text-xl font-semibold text-slate-800">Bulk Reports &amp; Trends</h2>
    <p class="text-slate-500">
      Select a dataset to generate reports, download a ZIP, and analyze individual technician trends over time.
    </p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
    <!-- Left Panel: Filters -->
    <div class="lg:col-span-3">
        <div class="space-y-4">
            <div>
                <label for="dataset-select" class="block text-sm font-medium text-slate-700 mb-1">Select Performance Week</label>
                <select id="dataset-select" [ngModel]="selectedDatasetId()" (ngModelChange)="selectedDatasetId.set($event)" class="w-full bg-white text-slate-800 p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none shadow-sm">
                    @if (datasets().length === 0) {
                      <option [ngValue]="null" disabled>No datasets uploaded</option>
                    }
                    @for (dataset of datasets(); track dataset.id) {
                      <option [ngValue]="dataset.id">{{ dataset.uploadDate | date:'mediumDate' }} ({{ dataset.fileName }})</option>
                    }
                </select>
            </div>
             <div>
                <label for="tech-search" class="block text-sm font-medium text-slate-700 mb-1">Filter Technicians</label>
                <input id="tech-search" type="text" [ngModel]="technicianFilterTerm()" (ngModelChange)="technicianFilterTerm.set($event)" class="w-full bg-white text-slate-800 p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none shadow-sm" placeholder="Search by name or ID...">
            </div>
        </div>
    </div>

    <!-- Center Panel: Technicians & Generation -->
    <div class="lg:col-span-5">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
             <div class="flex items-center">
                <input type="checkbox" id="select-all" (change)="toggleSelectAll($event)" [checked]="areAllFilteredTechniciansSelected()" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <label for="select-all" class="ml-2 block text-sm text-gray-900">Select All (Visible)</label>
            </div>
            <div class="flex gap-2">
                <button (click)="generateDashboards()" [disabled]="selectedTechnicianIds().size === 0 || isGenerating()" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2 text-sm disabled:bg-slate-300">Generate</button>
                <button (click)="publishAllReports()" [disabled]="!hasGeneratedUnpublishedReports() || isPublishing()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2 text-sm disabled:bg-blue-300">Publish All</button>
                <button (click)="downloadZip()" [disabled]="generatedReports().size === 0" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2 text-sm disabled:bg-green-300">Download ZIP</button>
            </div>
        </div>
        <div class="bg-slate-100/50 p-2 rounded-lg max-h-[60vh] overflow-y-auto border border-slate-200 shadow-inner">
            <div class="space-y-2">
                @for (tech of filteredTechniciansInDataset(); track tech.techId) {
                    <div class="bg-white p-3 rounded-lg flex items-center border border-slate-200">
                        <input type="checkbox" [checked]="selectedTechnicianIds().has(tech.techId)" (change)="toggleTechnicianSelection(tech.techId, $event)" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <div class="ml-3">
                            <p class="font-medium text-slate-800">{{ tech.name }}</p>
                            <p class="text-xs text-slate-500">#{{ tech.techId }}</p>
                        </div>
                        @if (generatedReports().has(tech.techId)) {
                             @if(generatedReports().get(tech.techId)!.isPublished) {
                                <span class="ml-auto px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Published</span>
                            } @else {
                                <span class="ml-auto px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Generated</span>
                            }
                        }
                    </div>
                } @empty {
                    <div class="p-4 text-center text-slate-500">
                        @if(selectedDatasetId()) {
                            <p>No technicians match your filter.</p>
                        } @else {
                            <p>Select a dataset to see technicians.</p>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Right Panel: Individual Analysis -->
    <div class="lg:col-span-4">
        <h3 class="text-lg font-semibold text-slate-800 mb-4">Performance Trend</h3>
        @if (selectedTechnicianForAnalysis(); as tech) {
            <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                <h4 class="font-bold text-center text-slate-800 text-lg">{{ tech.name }}</h4>
                <div class="my-4">
                    <h5 class="text-sm font-semibold mb-2">Compare Weeks:</h5>
                    <div class="max-h-24 overflow-y-auto space-y-1 text-sm border rounded p-2 bg-slate-50">
                        @for (dataset of availableTrendDatasets(); track dataset.id) {
                            <label class="flex items-center gap-2 p-1 rounded hover:bg-slate-200 cursor-pointer">
                                <input type="checkbox" [checked]="dataset.selected" (change)="toggleTrendDataset(dataset.id)" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span>{{ dataset.uploadDate | date:'mediumDate' }}</span>
                            </label>
                        }
                    </div>
                </div>
                @if(isAnalyzing()) {
                    <p class="text-center text-slate-500">Loading analysis...</p>
                } @else if (analysisData().length > 0) {
                    <div #trendChartContainer class="w-full h-[300px] mt-4"></div>
                    <div class="flex justify-center gap-4 mt-2 text-xs">
                        <span class="flex items-center gap-1"><div class="w-3 h-3 bg-[#4f46e5] rounded-sm"></div>Total Rating</span>
                        <span class="flex items-center gap-1"><div class="w-3 h-3 bg-[#059669] rounded-sm"></div>Points</span>
                        <span class="flex items-center gap-1"><div class="w-3 h-3 bg-[#ea580c] rounded-sm"></div>Pos. Comp %</span>
                        <span class="flex items-center gap-1"><div class="w-3 h-3 bg-[#0ea5e9] rounded-sm"></div>NPS %</span>
                    </div>
                } @else {
                    <p class="text-center text-slate-500 py-10">No data for selected week(s).</p>
                }
            </div>
        } @else {
            <div class="h-full bg-slate-100/50 p-4 rounded-lg border-2 border-dashed border-slate-200 flex items-center justify-center text-center">
                <p class="text-slate-500">Select a single technician to view their performance trend over time.</p>
            </div>
        }
    </div>
  </div>

  <!-- Generated Dashboards Preview -->
  @if (generatedReports().size > 0) {
    <div class="mt-12">
        <h3 class="text-xl font-semibold text-slate-800 mb-4">Generated Dashboards Preview</h3>
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
            @for (report of generatedReports() | keyvalue; track report.key) {
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm flex flex-col gap-4">
                    <div class="flex justify-between items-start gap-2">
                        <div>
                            <h4 class="font-bold text-slate-800 truncate">{{ report.value.techData['Name'] }}</h4>
                            @if(report.value.isPublished) {
                                <span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Published</span>
                            } @else if (report.value.imageDataUrl) {
                                <span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-amber-100 text-amber-800">Draft</span>
                            }
                        </div>
                         <div class="flex gap-2 flex-shrink-0">
                            @if (report.value.imageDataUrl) {
                                <button (click)="downloadSingleDashboard(report.value)" class="bg-slate-100 text-slate-700 hover:bg-slate-200 font-bold py-1 px-3 rounded-md text-sm transition-colors flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" /><path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" /></svg>
                                    Download
                                </button>
                            }
                            @if(report.value.isPublished) {
                                <button (click)="unpublishReport(report.key)" class="bg-amber-100 text-amber-700 hover:bg-amber-200 font-bold py-1 px-3 rounded-md text-sm">Unpublish</button>
                            } @else {
                                <button (click)="publishReport(report.key)" [disabled]="!report.value.imageDataUrl" class="bg-blue-100 text-blue-700 hover:bg-blue-200 font-bold py-1 px-3 rounded-md text-sm disabled:bg-slate-200 disabled:text-slate-500">Publish</button>
                            }
                        </div>
                    </div>
                    @if (report.value.imageDataUrl) {
                        <img [src]="report.value.imageDataUrl" alt="Performance Preview" class="w-full h-auto rounded border">
                    } @else if (report.value.isGenerating) {
                        <div class="aspect-[1200/1400] bg-slate-100 flex items-center justify-center rounded">
                            <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </div>
                    } @else {
                        <div class="aspect-[1200/1400] bg-red-50 text-red-700 flex items-center justify-center rounded border border-red-200">
                           Generation Failed
                        </div>
                    }
                    <div>
                      <label [for]="'notes-' + report.key" class="text-sm font-medium text-slate-500 mb-1 block">Notes</label>
                      <textarea [id]="'notes-' + report.key" [ngModel]="report.value.notes()" (ngModelChange)="report.value.notes.set($event)" rows="2" placeholder="Add optional notes..." class="w-full text-sm p-2 bg-slate-50 border border-slate-200 rounded-md focus:ring-2 focus:ring-blue-500/50 outline-none"></textarea>
                    </div>
                </div>
            }
        </div>
    </div>
  }

</div>

<!-- Hidden container for generating charts -->
<div class="fixed -top-[9999px] -left-[9999px] z-[-1] opacity-0 pointer-events-none">
  @if(isGenerating()) {
    @for(report of generatedReports() | keyvalue; track report.key) {
      <div [id]="'chart-gen-' + report.key">
        <app-performance-chart [techData]="report.value.techData" [perfData]="report.value.perfData"></app-performance-chart>
      </div>
    }
  }
</div>
