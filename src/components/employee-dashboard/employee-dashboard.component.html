<div class="min-h-screen bg-brand-background text-brand-text-primary font-sans">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Header -->
    <app-dashboard-header
      [pageTitle]="'My Dashboard'"
      [description]="'Welcome back, ' + (currentUser()?.name || '') +'.'"
      [showLogout]="true"
      (logout)="logout()">
    </app-dashboard-header>

    <!-- Main Content -->
    <main class="mt-8">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        <!-- Sidebar: Pay Period Selection -->
        <aside class="lg:col-span-1">
           <h3 class="text-lg font-semibold mb-4 px-2 text-brand-text-primary">Pay Periods</h3>
            <div class="space-y-2">
              <button 
                (click)="selectReport(null)"
                class="w-full text-left p-4 rounded-lg transition-all duration-200 group relative"
                [class]="selectedReportId() === null ? 'bg-brand-primary text-white shadow-md' : 'bg-brand-surface hover:bg-slate-50 text-brand-text-primary border border-brand-border'">
                 <span class="font-semibold block">Current Period</span>
                 <span class="text-sm opacity-80 block">Unprocessed Jobs</span>
              </button>
              
              <div class="bg-brand-surface rounded-lg max-h-[60vh] overflow-y-auto border border-brand-border shadow-sm p-2 space-y-2">
                @for (report of payrollHistory(); track report.id) {
                  <button 
                    (click)="selectReport(report.id)"
                    class="w-full text-left p-3 rounded-md transition-colors duration-200"
                    [class]="selectedReportId() === report.id ? 'bg-brand-nav-active-bg text-brand-nav-active-text' : 'hover:bg-slate-100'">
                    <p class="font-semibold">{{ report.startDate | date:'mediumDate' }}</p>
                    <p class="text-sm opacity-70">to {{ report.endDate | date:'mediumDate' }}</p>
                  </button>
                }
              </div>
            </div>
        </aside>

        <!-- Details -->
        <div class="lg:col-span-3">
          @if (selectedReport(); as report) {
            @let data = report.reportData;
            <div class="animate-fade-in space-y-8">
              <!-- Header Card -->
              <div class="bg-brand-surface p-6 sm:p-8 rounded-xl border border-brand-border shadow-sm">
                 <div class="flex flex-col sm:flex-row justify-between sm:items-start gap-4">
                    <div>
                      <p class="text-brand-text-secondary text-sm">Payout for {{ report.startDate | date:'MMM d' }} - {{ report.endDate | date:'MMM d, y' }}</p>
                      <p class="text-5xl lg:text-6xl font-bold text-brand-success mt-2">{{ data.totalEarnings | currency:'USD':'symbol':'1.2-2' }}</p>
                    </div>
                    <button (click)="downloadReportAsPDF(report)" class="bg-brand-primary hover:bg-brand-primary-hover text-brand-text-on-primary font-bold py-2.5 px-5 rounded-lg flex items-center gap-2 transition-colors shadow-sm hover:shadow-md">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                      <span>Download PDF</span>
                    </button>
                 </div>
              </div>
              
              <!-- Stat Cards -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                 <div class="bg-brand-surface p-5 rounded-xl border border-brand-border shadow-sm"><div class="text-brand-text-secondary text-sm">Total Jobs</div><div class="text-3xl font-bold text-brand-text-primary mt-1">{{ data.totalJobs }}</div></div>
                 <div class="bg-brand-surface p-5 rounded-xl border border-brand-border shadow-sm"><div class="text-brand-text-secondary text-sm">Base Earnings</div><div class="text-3xl font-bold text-brand-text-primary mt-1">{{ baseEarnings() | currency }}</div></div>
                 <div class="bg-brand-surface p-5 rounded-xl border border-brand-border shadow-sm"><div class="text-brand-text-secondary text-sm">Average Per Job</div><div class="text-3xl font-bold text-brand-text-primary mt-1">{{ data.avgPerJob | currency }}</div></div>
              </div>

              <!-- Breakdowns -->
              <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                  <!-- Adjustments -->
                  <div class="lg:col-span-2 bg-brand-surface p-6 rounded-xl border border-brand-border shadow-sm">
                      <h3 class="text-xl font-semibold mb-4 text-brand-text-primary">Adjustments</h3>
                      @if(data.adjustments.length > 0) {
                        <ul class="divide-y divide-brand-border -mx-6">
                          @for(adj of data.adjustments; track adj.id) {
                            <li class="flex justify-between items-center py-3.5 px-6">
                              <div>
                                <p class="font-semibold text-brand-text-primary">{{ adj.description }}</p>
                                <p class="text-sm text-brand-text-secondary">{{ adj.type }}</p>
                              </div>
                              <span class="text-lg font-mono font-bold" [class.text-brand-success]="adj.amount > 0" [class.text-brand-danger]="adj.amount < 0">{{ adj.amount | currency }}</span>
                            </li>
                          }
                        </ul>
                      } @else {
                        <p class="text-center text-brand-text-secondary py-4">No bonuses or deductions for this period.</p>
                      }
                  </div>
                  <!-- Jobs -->
                  <div class="lg:col-span-3 bg-brand-surface p-6 rounded-xl border border-brand-border shadow-sm">
                      <h3 class="text-xl font-semibold mb-4 text-brand-text-primary">Jobs</h3>
                       @if(data.processedJobs && data.processedJobs.length > 0) {
                        <div class="max-h-[400px] overflow-y-auto border border-brand-border rounded-md">
                          <table class="w-full text-left">
                            <thead class="sticky top-0 bg-slate-50 z-10 border-b border-brand-border"><tr><th class="p-3 text-sm font-semibold uppercase text-brand-text-secondary tracking-wider">Date</th><th class="p-3 text-sm font-semibold uppercase text-brand-text-secondary tracking-wider">Task</th><th class="p-3 text-sm font-semibold uppercase text-brand-text-secondary tracking-wider text-right">Rate</th><th class="p-3 text-sm font-semibold uppercase text-brand-text-secondary tracking-wider text-right">Earning</th></tr></thead>
                            <tbody class="divide-y divide-brand-border">
                              @for(job of data.processedJobs; track job.id) {
                                <tr class="hover:bg-slate-50/70"><td class="p-3 text-brand-text-primary text-sm">{{ job.date | date:'shortDate' }}</td><td class="p-3 text-brand-text-primary text-sm">{{ job.taskCode }}</td><td class="p-3 font-mono text-right text-brand-text-secondary text-sm">{{ job.rateApplied | currency }}</td><td class="p-3 font-mono text-right text-brand-text-primary text-sm font-semibold">{{ job.earning | currency }}</td></tr>
                              }
                            </tbody>
                          </table>
                        </div>
                      } @else {
                        <p class="text-center text-brand-text-secondary py-8">No jobs recorded for this period.</p>
                      }
                  </div>
              </div>
            </div>
          } @else {
             <!-- Current Unprocessed Jobs View -->
             <div class="animate-fade-in space-y-8">
                <div class="bg-brand-surface p-6 sm:p-8 rounded-xl border border-brand-border shadow-sm">
                   <p class="text-brand-text-secondary text-sm">Estimated earnings for current period</p>
                   <p class="text-5xl lg:text-6xl font-bold text-brand-primary mt-2">{{ unprocessedSummary().estimatedEarnings | currency:'USD':'symbol':'1.2-2' }}</p>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                   <div class="bg-brand-surface p-5 rounded-xl border border-brand-border shadow-sm">
                      <div class="text-brand-text-secondary text-sm">Unprocessed Jobs</div>
                      <div class="text-3xl font-bold text-brand-text-primary mt-1">{{ unprocessedSummary().totalJobs }}</div>
                  </div>
                   <div class="bg-brand-surface p-5 rounded-xl border border-brand-border shadow-sm">
                      <div class="text-brand-text-secondary text-sm">Total Revenue Generated</div>
                      <div class="text-3xl font-bold text-brand-text-primary mt-1">{{ unprocessedSummary().totalRevenue | currency }}</div>
                  </div>
                </div>
                 <div class="bg-brand-surface p-6 rounded-xl border border-brand-border shadow-sm">
                    <h3 class="text-xl font-semibold mb-4 text-brand-text-primary">Unprocessed Jobs Details</h3>
                     @if(unprocessedJobsWithEarnings().length > 0) {
                      <div class="max-h-[400px] overflow-y-auto border border-brand-border rounded-md">
                        <table class="w-full text-left">
                          <thead class="sticky top-0 bg-slate-50 z-10 border-b border-brand-border"><tr><th class="p-3 text-sm font-semibold uppercase text-brand-text-secondary tracking-wider">Date</th><th class="p-3 text-sm font-semibold uppercase text-brand-text-secondary tracking-wider">Task</th><th class="p-3 text-sm font-semibold uppercase text-brand-text-secondary tracking-wider text-right">Est. Earning</th></tr></thead>
                          <tbody class="divide-y divide-brand-border">
                            @for(job of unprocessedJobsWithEarnings(); track job.id) {
                              <tr class="hover:bg-slate-50/70">
                                <td class="p-3 text-brand-text-primary text-sm">{{ job.date | date:'shortDate' }}</td>
                                <td class="p-3 text-brand-text-primary text-sm">{{ job.taskCode }} (x{{job.quantity}})</td>
                                <td class="p-3 font-mono text-right text-brand-text-primary text-sm font-semibold">{{ job.earning | currency }}</td>
                              </tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    } @else {
                      <div class="text-center text-brand-text-secondary py-8 rounded-lg border-2 border-dashed border-brand-border">
                         <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>
                         <h3 class="mt-4 text-lg font-semibold text-brand-text-primary">All Caught Up!</h3>
                         <p class="mt-1 text-sm">No jobs have been uploaded for the upcoming pay period yet.</p>
                      </div>
                    }
                </div>
            </div>
          }
        </div>
      </div>
    </main>
  </div>
</div>
