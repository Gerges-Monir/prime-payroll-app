<div class="animate-fade-in">
  <div class="mb-6">
    <h2 class="text-xl font-semibold text-slate-800">Payroll History</h2>
    <p class="text-slate-500">Review, finalize, and manage all payroll reports.</p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Payroll List -->
    <div class="lg:col-span-1">
      <h3 class="text-lg font-semibold mb-4 text-slate-800">Saved Periods</h3>
      <div class="bg-slate-100/50 p-2 rounded-lg max-h-[600px] overflow-y-auto border border-slate-200 shadow-inner">
        <div class="space-y-2">
          @for (payroll of publishedPayrolls(); track payroll.id) {
            <button 
              (click)="selectPayroll(payroll.id)"
              [class]="(selectedPayrollId() === payroll.id ? 'bg-blue-600 text-white ring-2 ring-offset-2 ring-blue-400 shadow-lg' : 'bg-white hover:bg-slate-100 text-slate-800') + ' w-full text-left p-4 rounded-lg border border-slate-200 shadow-sm hover:shadow-md transition-all'">
              <div class="flex justify-between items-start">
                  <div>
                    <p class="font-semibold">
                      {{ payroll.startDate | date:'mediumDate' }} - {{ payroll.endDate | date:'mediumDate' }}
                    </p>
                    <p class="text-sm" [class]="selectedPayrollId() === payroll.id ? 'text-blue-200' : 'opacity-70'">Published on: {{ payroll.publishedDate | date:'shortDate' }}</p>
                  </div>
              </div>
            </button>
          } @empty {
            <div class="p-8 text-center text-slate-500">
              <p>No payrolls have been published yet.</p>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Payroll Details -->
    <div class="lg:col-span-2">
       @if (selectedPayroll(); as payroll) {
        <div class="animate-fade-in-fast">
          <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-4">
            <h3 class="text-lg font-semibold text-slate-800">Report for {{ payroll.startDate | date:'MMM d' }} - {{ payroll.endDate | date:'MMM d, y' }}</h3>
            <!-- Action Buttons -->
            <div class="flex gap-2 flex-shrink-0">
              <button (click)="delete(payroll, $event)" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-sm flex items-center gap-2 shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 1 0 .23 1.482l.149-.022.841 10.518A2.75 2.75 0 0 0 7.596 19h4.807a2.75 2.75 0 0 0 2.742-2.53l.841-10.52.149.023a.75.75 0 0 0 .23-1.482A41.03 41.03 0 0 0 14 4.193V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 0 0-1.5.06l.3 7.5a.75.75 0 1 0 1.5-.06l-.3-7.5Zm4.34.06a.75.75 0 1 0-1.5-.06l-.3 7.5a.75.75 0 1 0 1.5.06l.3-7.5Z" clip-rule="evenodd" /></svg> Unpublish</button>
            </div>
          </div>
          <div class="border border-slate-200 rounded-lg shadow-md">
             <div class="max-h-[600px] overflow-y-auto">
                <table class="w-full text-left">
                  <thead class="sticky top-0 bg-slate-100 z-10 border-b border-slate-200">
                    <tr>
                      <th class="p-4 text-sm font-semibold uppercase text-slate-500 tracking-wider">Technician</th>
                      <th class="p-4 text-sm font-semibold uppercase text-slate-500 tracking-wider text-right">Jobs</th>
                      <th class="p-4 text-sm font-semibold uppercase text-slate-500 tracking-wider text-right">Adjustments</th>
                      <th class="p-4 text-sm font-semibold uppercase text-slate-500 tracking-wider text-right">Final Payout</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-200">
                    @for (tech of payroll.reportData; track tech.id) {
                      @let adjTotal = getAdjustmentsTotal(tech);
                      <tr class="hover:bg-slate-50 cursor-pointer" (click)="toggleTechnicianDetails(tech.id)">
                        <td class="p-4">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" 
                                     class="w-4 h-4 text-slate-500 transition-transform"
                                     [class.rotate-90]="selectedTechnicianId() === tech.id">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
                                </svg>
                                <div>
                                    <p class="font-medium text-slate-800">{{ tech.name }}</p>
                                    <p class="text-sm text-slate-500">#{{ tech.techId }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="p-4 text-right font-mono text-slate-800">{{ tech.totalJobs }}</td>
                        <td 
                          class="p-4 text-right font-mono"
                          [class.text-slate-500]="adjTotal === 0"
                          [class.text-green-600]="adjTotal > 0"
                          [class.text-red-600]="adjTotal < 0">
                          {{ adjTotal | currency }}
                        </td>
                        <td class="p-4 text-right font-mono text-green-600 font-bold">{{ tech.totalEarnings | currency }}</td>
                      </tr>
                      @if (selectedTechnicianId() === tech.id) {
                        <tr>
                            <td colspan="4" class="p-0 bg-blue-50">
                                <div class="p-4 animate-fade-in-fast">
                                    <h4 class="font-semibold text-slate-800 mb-2">Job Details for {{tech.name}}</h4>
                                    @if(tech.processedJobs && tech.processedJobs.length > 0) {
                                      <div class="max-h-64 overflow-y-auto border border-slate-200 rounded-md">
                                        <table class="w-full text-sm text-left bg-white">
                                          <thead class="sticky top-0 bg-blue-100 z-10">
                                            <tr>
                                              <th class="p-2 font-semibold text-slate-600">Date</th>
                                              <th class="p-2 font-semibold text-slate-600">Task</th>
                                              <th class="p-2 font-semibold text-slate-600 text-right">Revenue</th>
                                              <th class="p-2 font-semibold text-slate-600 text-right">Rate</th>
                                              <th class="p-2 font-semibold text-slate-600 text-right">Earning</th>
                                            </tr>
                                          </thead>
                                          <tbody class="divide-y divide-slate-200">
                                            @for(job of tech.processedJobs; track job.id) {
                                              <tr>
                                                <td class="p-2">{{ job.date | date:'shortDate' }}</td>
                                                <td class="p-2">{{ job.taskCode }} (x{{job.quantity}})</td>
                                                <td class="p-2 text-right font-mono">{{ job.revenue | currency }}</td>
                                                <td class="p-2 text-right font-mono text-slate-500">{{ job.rateApplied | currency }}</td>
                                                <td class="p-2 text-right font-mono font-semibold">{{ job.earning | currency }}</td>
                                              </tr>
                                            }
                                          </tbody>
                                        </table>
                                      </div>
                                    } @else {
                                      <p class="text-center text-slate-500 py-4">No jobs were processed for this technician in this period.</p>
                                    }
                                </div>
                            </td>
                        </tr>
                      }
                    }
                  </tbody>
                </table>
             </div>
          </div>
        </div>
       } @else {
        <div class="h-full flex items-center justify-center text-center text-slate-500 bg-slate-100/70 rounded-lg border-2 border-dashed border-slate-200 shadow-md">
          <div>
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-sky-500" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672 13.684 16.6m0 0-2.51 2.225.569-9.47 5.227 7.917-3.286-.672ZM12 2.25V4.5m5.834.166-1.591 1.591M20.25 10.5H18M12 21.75V19.5M5.834 18.834 7.425 17.243M3.75 10.5H6M4.166 5.166 5.757 6.757" /></svg>
            <h2 class="text-2xl font-bold text-slate-800 mt-4">Select a Payroll Period</h2>
            <p class="mt-2 text-lg">Choose a saved report from the list to view its details.</p>
          </div>
        </div>
       }
    </div>
  </div>
</div>

@if (showDeleteConfirm()) {
  <app-confirmation-modal 
    title="Confirm Unpublish Payroll"
    message="Are you sure you want to unpublish this payroll? This will remove it from all employee and supervisor dashboards. You will still be able to see it here in your history."
    confirmText="Unpublish"
    confirmStyle="danger"
    (confirmed)="handleDelete($event)">
  </app-confirmation-modal>
}