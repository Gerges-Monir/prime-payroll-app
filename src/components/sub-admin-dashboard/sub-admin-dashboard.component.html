<div class="flex min-h-screen bg-brand-background font-sans">
  <app-sidebar [tabs]="tabs" [activeTab]="activeTab()" (tabSelected)="selectTab($event)" (logout)="logout()"></app-sidebar>
  
  <div class="flex-1 flex flex-col md:ml-64 transition-all duration-300">
    <main class="flex-1 p-6 sm:p-8">
      <!-- Header -->
      <app-dashboard-header
        [pageTitle]="'Sub-Admin Dashboard'"
        [description]="'Managing team for ' + (currentUser()?.name || '')">
      </app-dashboard-header>
      
      <div class="mt-6">
        <!-- Stats Grid -->
        <app-stat-cards [stats]="teamStats()"></app-stat-cards>

        <!-- Main Content -->
        <div class="bg-brand-surface p-6 rounded-lg border border-brand-border mt-8">
          
          <!-- Team Report Tab -->
          @if(activeTab() === 'report') {
            <div>
              <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                <div>
                  <h3 class="text-xl font-semibold text-brand-text-primary">Current Payroll Report</h3>
                  <p class="text-sm text-brand-text-secondary mt-1">Summary of current unprocessed jobs and adjustments for your team.</p>
                </div>
                <button (click)="downloadExcel()" [disabled]="teamProcessedTechnicians().length === 0" class="bg-white border border-brand-border text-brand-text-secondary hover:bg-slate-100 hover:text-brand-text-primary font-bold py-2 px-4 rounded-lg flex items-center gap-2 disabled:bg-slate-200 disabled:text-slate-400 disabled:cursor-not-allowed transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                  <span>Download Excel</span>
                </button>
              </div>
              <div class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                @for (tech of teamProcessedTechnicians(); track tech.id) {
                  <div class="bg-slate-50/70 p-4 rounded-lg hover:shadow-md transition-shadow border border-brand-border cursor-pointer" (click)="toggleTechnicianDetails(tech.id)">
                      <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" 
                                class="w-4 h-4 text-brand-text-secondary transition-transform"
                                [class.rotate-90]="selectedReportTechnicianId() === tech.id">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
                          </svg>
                          <p class="font-bold text-lg text-brand-text-primary">{{ tech.name }} <span class="text-sm text-brand-text-secondary">#{{ tech.techId }}</span></p>
                        </div>
                        <span class="text-green-600 font-semibold text-lg">{{ tech.totalEarnings | currency }}</span>
                      </div>
                      <div class="text-sm text-brand-text-secondary grid grid-cols-2 md:grid-cols-4 gap-x-4 mt-2 ml-6">
                        <span>Jobs: <span class="font-medium text-brand-text-primary">{{ tech.totalJobs }}</span></span>
                        <span>Revenue: <span class="font-medium text-brand-text-primary">{{ tech.totalRevenue | currency }}</span></span>
                        <span>Adjustments: <span class="font-medium text-brand-text-primary">{{ getAdjustmentsTotal(tech) | currency }}</span></span>
                        <span>Co. Revenue: <span class="font-medium text-brand-text-primary">{{ tech.companyRevenue | currency }}</span></span>
                      </div>
                  </div>
                   @if (selectedReportTechnicianId() === tech.id) {
                    <div class="p-4 bg-slate-100 rounded-b-lg ml-6 border-x border-b border-brand-border animate-fade-in-fast">
                      <h4 class="font-semibold text-brand-text-primary mb-2">Unprocessed Jobs for {{tech.name}}</h4>
                      @if(selectedTechnicianJobs().length > 0) {
                        <div class="max-h-48 overflow-y-auto border border-brand-border rounded-md">
                          <table class="w-full text-sm text-left bg-white">
                            <thead class="sticky top-0 bg-slate-200 z-10">
                              <tr>
                                <th class="p-2 font-semibold text-brand-text-secondary">Date</th>
                                <th class="p-2 font-semibold text-brand-text-secondary">Task</th>
                                <th class="p-2 font-semibold text-brand-text-secondary text-right">Revenue</th>
                              </tr>
                            </thead>
                            <tbody class="divide-y divide-brand-border">
                              @for(job of selectedTechnicianJobs(); track job.id) {
                                <tr>
                                  <td class="p-2">{{ job.date | date:'shortDate' }}</td>
                                  <td class="p-2">{{ job.taskCode }} (x{{job.quantity}})</td>
                                  <td class="p-2 text-right font-mono">{{ job.revenue | currency }}</td>
                                </tr>
                              }
                            </tbody>
                          </table>
                        </div>
                      } @else {
                        <p class="text-center text-brand-text-secondary py-4">No unprocessed jobs for this technician.</p>
                      }
                    </div>
                  }
                } @empty {
                  <div class="text-center text-brand-text-secondary py-16">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                    <h3 class="mt-4 text-xl font-semibold text-brand-text-primary">No Data Processed Yet</h3>
                    <p class="mt-1">When an administrator uploads a file, the processed data for your team will appear here.</p>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Manage Jobs Tab -->
          @if(activeTab() === 'jobs') {
            <div>
              <h2 class="text-xl font-semibold mb-4 text-brand-text-primary">Manage Team Jobs</h2>
              <div class="border border-brand-border rounded-lg">
                <div class="max-h-[600px] overflow-y-auto">
                  <table class="w-full text-left">
                    <thead class="sticky top-0 bg-slate-50 z-10 border-b border-brand-border">
                      <tr>
                        <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary">Technician</th>
                        <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary">Date</th>
                        <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary">Task Code</th>
                        <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary text-right">Revenue</th>
                        <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary text-right">Actions</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-brand-border">
                      @for (job of teamJobs(); track job.id) {
                        <tr class="hover:bg-slate-50/70">
                          <td class="p-4 font-medium text-brand-text-primary">{{ getTechName(job.techId) }} (#{{ job.techId }})</td>
                          <td class="p-4 text-brand-text-primary">{{ job.date | date:'shortDate' }}</td>
                          <td class="p-4 text-brand-text-primary">{{ job.taskCode }}</td>
                          <td class="p-4 font-mono text-right text-brand-text-primary">{{ job.revenue | currency }}</td>
                          <td class="p-4 text-right">
                             <div class="flex justify-end gap-2">
                                <button (click)="openEditJobModal(job)" class="bg-white border border-brand-border text-brand-text-secondary hover:bg-slate-100 hover:text-brand-text-primary font-bold py-1 px-3 rounded-md text-sm transition-colors">Edit</button>
                                <button (click)="deleteJob(job.id)" class="bg-white border border-red-300 text-red-600 hover:bg-red-50 font-bold py-1 px-3 rounded-md text-sm transition-colors">Delete</button>
                             </div>
                          </td>
                        </tr>
                      } @empty {
                        <tr>
                          <td colspan="5" class="text-center text-brand-text-secondary py-16">
                            <h3 class="text-xl font-semibold text-brand-text-primary">No Jobs to Display</h3>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          }

           <!-- My Team Tab -->
          @if(activeTab() === 'team') {
            <div>
              <h2 class="text-xl font-semibold mb-4 text-brand-text-primary">My Team Members</h2>
               <div class="border border-brand-border rounded-lg">
                <div class="max-h-[600px] overflow-y-auto">
                  <table class="w-full text-left">
                    <thead class="sticky top-0 bg-slate-50 z-10 border-b border-brand-border">
                      <tr>
                        <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary">Name</th>
                        <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary">Details</th>
                        <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary">Rate Category</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-brand-border">
                      @for (member of teamMembers(); track member.id) {
                        <tr class="hover:bg-slate-50/70">
                          <td class="p-4">
                            <p class="font-medium text-brand-text-primary">{{ member.name }}</p>
                            <p class="text-sm text-brand-text-secondary">#{{ member.techId }}</p>
                          </td>
                          <td class="p-4">
                            <p class="text-sm text-brand-text-primary">{{ member.email }}</p>
                            <p class="text-sm text-brand-text-secondary">{{ member.phone }}</p>
                          </td>
                          <td class="p-4 text-brand-text-primary">{{ getRateCategoryName(member.rateCategoryId) }}</td>
                        </tr>
                      } @empty {
                        <tr>
                          <td colspan="3" class="text-center text-brand-text-secondary py-16">
                            <h3 class="text-xl font-semibold text-brand-text-primary">No Employees Assigned</h3>
                            <p class="mt-1">An administrator needs to assign employees to you.</p>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          }

          <!-- Team History Tab -->
          @if(activeTab() === 'teamHistory') {
            <div>
              <div class="mb-6">
                <h2 class="text-xl font-semibold text-brand-text-primary">Team Payroll History</h2>
                <p class="text-brand-text-secondary text-sm mt-1">Review finalized payroll reports for your team.</p>
              </div>
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Payroll List -->
                <div class="lg:col-span-1">
                  <h3 class="text-lg font-semibold mb-4 text-brand-text-primary">Finalized Periods</h3>
                  <div class="bg-slate-50/70 p-2 rounded-lg max-h-[600px] overflow-y-auto border border-brand-border">
                    <div class="space-y-2">
                      @for (payroll of teamPayrollHistory(); track payroll.id) {
                        <button 
                          (click)="selectTeamPayroll(payroll.id)"
                          [class]="(selectedTeamPayrollId() === payroll.id ? 'bg-brand-primary text-white ring-2 ring-brand-accent' : 'bg-brand-surface hover:bg-slate-100 text-brand-text-primary') + ' w-full text-left p-4 rounded-lg transition-all duration-200 border border-brand-border'">
                          <p class="font-semibold">{{ payroll.startDate | date:'mediumDate' }} - {{ payroll.endDate | date:'mediumDate' }}</p>
                          <p class="text-sm opacity-70">Published: {{ payroll.publishedDate | date:'shortDate' }}</p>
                        </button>
                      } @empty {
                        <div class="p-8 text-center text-brand-text-secondary">
                          <p>No finalized payroll history for your team yet.</p>
                        </div>
                      }
                    </div>
                  </div>
                </div>
                <!-- Payroll Details -->
                <div class="lg:col-span-2">
                  @if (selectedTeamPayroll(); as payroll) {
                    <div class="animate-fade-in-fast">
                      <h3 class="text-lg font-semibold mb-4 text-brand-text-primary">Report for {{ payroll.startDate | date:'MMM d' }} - {{ payroll.endDate | date:'MMM d, y' }}</h3>
                      <div class="border border-brand-border rounded-lg">
                        <div class="max-h-[600px] overflow-y-auto">
                            <table class="w-full text-left">
                              <thead class="sticky top-0 bg-slate-50 z-10 border-b border-brand-border">
                                <tr>
                                  <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary">Technician</th>
                                  <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary text-right">Jobs</th>
                                  <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary text-right">Adjustments</th>
                                  <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary text-right">Final Payout</th>
                                </tr>
                              </thead>
                              <tbody class="divide-y divide-brand-border">
                                @for (tech of payroll.reportData; track tech.id) {
                                  @let adjTotal = getAdjustmentsTotal(tech);
                                  <tr class="hover:bg-slate-50/70">
                                    <td class="p-4">
                                        <p class="font-medium text-brand-text-primary">{{ tech.name }}</p>
                                        <p class="text-sm text-brand-text-secondary">#{{ tech.techId }}</p>
                                    </td>
                                    <td class="p-4 text-right font-mono text-brand-text-primary">{{ tech.totalJobs }}</td>
                                    <td 
                                      class="p-4 text-right font-mono"
                                      [class.text-slate-500]="adjTotal === 0"
                                      [class.text-green-600]="adjTotal > 0"
                                      [class.text-red-600]="adjTotal < 0">
                                      {{ adjTotal | currency }}
                                    </td>
                                    <td class="p-4 text-right font-mono text-green-600 font-bold">{{ tech.totalEarnings | currency }}</td>
                                  </tr>
                                }
                              </tbody>
                            </table>
                        </div>
                      </div>
                    </div>
                  } @else {
                    <div class="h-full flex items-center justify-center text-center text-brand-text-secondary bg-slate-50/70 rounded-lg border-2 border-dashed border-brand-border">
                      <div>
                        <div class="text-6xl mb-4 text-slate-400">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        </div>
                        <h2 class="text-2xl font-bold text-brand-text-primary">Select a Payroll Period</h2>
                        <p class="mt-2 text-lg">Choose a finalized report from the list to view details for your team.</p>
                      </div>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Edit Job Modal -->
@if (showJobModal()) {
  <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 animate-fade-in p-4">
    <div class="bg-brand-surface rounded-lg shadow-2xl p-8 w-full max-w-md m-4 border border-brand-border">
      <h2 class="text-2xl font-bold mb-6 text-brand-text-primary">Edit Job for {{ getTechName(jobToEdit()?.techId || '') }}</h2>
      <form [formGroup]="jobForm" (ngSubmit)="saveJob()">
        <div class="space-y-4">
            <input formControlName="date" type="date" class="bg-slate-50 text-brand-text-primary p-3 rounded-md w-full border border-brand-border focus:ring-2 focus:ring-brand-accent outline-none">
            <input formControlName="taskCode" placeholder="Task Code" class="bg-slate-50 text-brand-text-primary p-3 rounded-md w-full border border-brand-border focus:ring-2 focus:ring-brand-accent outline-none">
            <input formControlName="revenue" type="number" step="0.01" placeholder="Revenue" class="bg-slate-50 text-brand-text-primary p-3 rounded-md w-full border border-brand-border focus:ring-2 focus:ring-brand-accent outline-none">
        </div>
        <div class="flex justify-end gap-4 mt-8">
          <button type="button" (click)="closeJobModal()" class="bg-white hover:bg-slate-100 text-brand-text-secondary border border-brand-border font-bold py-2 px-6 rounded-lg transition-colors">Cancel</button>
          <button type="submit" [disabled]="jobForm.invalid" class="bg-brand-primary hover:bg-brand-accent text-white font-bold py-2 px-6 rounded-lg disabled:bg-slate-400 transition-colors">Save Job</button>
        </div>
      </form>
    </div>
  </div>
}