<div class="animate-fade-in">
  <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
    <div class="flex items-center gap-2">
      <div>
        <h2 class="text-xl font-semibold text-slate-800">Upload Monthly Chargebacks</h2>
        <p class="text-slate-500">Upload and manage monthly chargeback reports for sub-admins and unassigned employees.</p>
      </div>
      <button (click)="showFormatHelp.set(true)" type="button" class="text-slate-400 hover:text-blue-600" title="View expected file format">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
     <button (click)="publishAllForMonth()" [disabled]="!hasDraftsForMonth()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors shadow-sm disabled:bg-slate-300 disabled:cursor-not-allowed">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3.105 6.187a.75.75 0 0 1 1.06 0l4.652 4.652 8.06-8.06a.75.75 0 0 1 1.06 1.06l-8.59 8.59a.75.75 0 0 1-1.06 0l-5.182-5.182a.75.75 0 0 1 0-1.06Z" /></svg>
      <span>Publish All for Month</span>
    </button>
  </div>

  <!-- Month Selector -->
  <div class="mb-6">
    <label for="month-select" class="block text-sm font-medium text-slate-500 mb-1">Select Month</label>
    <select id="month-select" [(ngModel)]="selectedMonth" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full md:w-1/2 lg:w-1/3 border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
      @if (availableMonths().length === 0) {
        <option value="" disabled>No data available to determine months</option>
      }
      @for(month of availableMonths(); track month.id) {
        <option [value]="month.id">{{ month.display }}</option>
      }
    </select>
  </div>
  
  @if (selectedMonth()) {
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
      @for (data of userReportData(); track data.user.id) {
        @let isPublished = data.report?.status === 'published';
        <div class="bg-white p-4 rounded-lg border border-slate-200 space-y-4 shadow-sm hover:shadow-md transition-shadow">
          <!-- User Header -->
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-slate-100 text-blue-800 flex items-center justify-center font-bold text-sm shrink-0 shadow-md">
              {{ getInitials(data.user.name) }}
            </div>
            <div class="flex-grow">
              <p class="font-semibold text-slate-800">{{ data.user.name }}</p>
              <p class="text-xs text-slate-500 capitalize">#{{ data.user.techId }} | {{ data.user.role }}</p>
            </div>
            @if(data.report) {
              <span class="px-2 py-1 text-xs font-semibold rounded-full" 
                    [class.bg-green-100]="isPublished" [class.text-green-800]="isPublished"
                    [class.bg-amber-100]="!isPublished" [class.text-amber-800]="!isPublished">
                {{ isPublished ? 'Published' : 'Draft' }}
              </span>
            }
          </div>
          
          <!-- Upload Area / Summary -->
          <div class="bg-slate-100 rounded border-2 border-dashed border-slate-200 p-4">
            @if (data.report) {
                <div class="text-center">
                    <p class="text-sm text-slate-500">File: {{ data.report.fileName }}</p>
                    <p class="text-2xl font-bold text-red-600 mt-1">{{ data.report.totalCharge | currency }}</p>
                    <p class="text-sm font-semibold text-slate-500">Total Charge</p>
                </div>
            } @else {
                <div class="text-center text-slate-500 py-4">
                    <p>No report uploaded for this month.</p>
                </div>
            }
          </div>
          
          <!-- Actions -->
          <div class="flex gap-2 justify-end">
            <label class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer text-sm shadow-sm hover:shadow-md transition-all">
                {{ data.report ? 'Replace File' : 'Upload File' }}
                <input type="file" (change)="onFileSelected($event, data)" accept=".xlsx" class="hidden">
            </label>
            @if (data.report) {
                 <button (click)="deleteReport(data)" class="bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 font-bold py-2 px-4 rounded-lg text-sm">
                   {{ data.report?.status === 'published' ? 'Unpublish' : 'Delete' }}
                 </button>
            }
          </div>

           @if (data.status !== 'idle') {
                <div class="p-2 rounded-md text-xs text-center"
                    [class.bg-blue-100]="data.status === 'uploading'" [class.text-blue-800]="data.status === 'uploading'"
                    [class.bg-green-100]="data.status === 'success'" [class.text-green-800]="data.status === 'success'"
                    [class.bg-red-100]="data.status === 'error'" [class.text-red-800]="data.status === 'error'">
                    {{ data.message }}
                </div>
           }

        </div>
      }
    </div>
  } @else {
     <div class="text-center py-20 text-slate-500 bg-slate-100/70 rounded-lg border-2 border-dashed border-slate-200">
      <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-sky-500" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18" /></svg>
      <h2 class="text-2xl font-bold text-slate-800 mt-4">Select a Month</h2>
      <p class="mt-2 text-lg">Choose a month from the dropdown to manage chargeback reports.</p>
    </div>
  }
</div>

<!-- Format Help Modal -->
@if (showFormatHelp()) {
  <div class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in p-4" (click)="showFormatHelp.set(false)">
    <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-lg border border-slate-200" (click)="$event.stopPropagation()">
      <div class="flex justify-between items-start">
        <h2 class="text-xl font-bold mb-4 text-slate-800">Expected Chargeback Format</h2>
        <button (click)="showFormatHelp.set(false)" class="text-slate-500 hover:text-slate-800">&times;</button>
      </div>
      <p class="text-sm text-slate-600 mb-4">The file should contain columns for 'Chargeback' and 'Amount'. A 'Company' column is optional. The parser will also look for a special row to identify the total charge.</p>
      
      <div class="border border-slate-200 rounded-lg overflow-hidden">
        <table class="w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="p-3 font-semibold text-slate-600">Company</th>
              <th class="p-3 font-semibold text-slate-600">Chargeback</th>
              <th class="p-3 font-semibold text-slate-600 text-right">Amount</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-slate-200">
            <tr>
              <td class="p-3 font-mono text-slate-800">Optimum</td>
              <td class="p-3 font-mono text-slate-800">Damaged Equipment</td>
              <td class="p-3 font-mono text-slate-800 text-right">-75.00</td>
            </tr>
             <tr>
              <td class="p-3 font-mono text-slate-800">Glo Fiber</td>
              <td class="p-3 font-mono text-slate-800">Incomplete Install</td>
              <td class="p-3 font-mono text-slate-800 text-right">-120.00</td>
            </tr>
             <tr class="bg-slate-50 font-bold">
              <td class="p-3 font-mono text-slate-800"></td>
              <td class="p-3 font-mono text-slate-800">Total Charge</td>
              <td class="p-3 font-mono text-slate-800 text-right">-195.00</td>
            </tr>
          </tbody>
        </table>
      </div>
       <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800 space-y-1">
        <p>If the 'Total Charge' row is not found, the system will sum all 'Amount' columns as a fallback.</p>
      </div>
    </div>
  </div>
}
