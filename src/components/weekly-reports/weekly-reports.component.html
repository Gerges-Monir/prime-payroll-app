<div class="animate-fade-in">
  <div class="flex flex-col md:flex-row justify-between md:items-start mb-6 gap-4">
    <div>
      <h2 class="text-2xl font-bold">ðŸ“… Weekly Reports</h2>
      <p class="text-gray-400">Select a week and filter by day to view its summary and publish the payroll.</p>
    </div>
    <div class="flex flex-col sm:flex-row gap-2">
      <button 
        (click)="downloadExcel()" 
        [disabled]="!reportForSelectedWeek() || reportForSelectedWeek()?.length === 0"
        class="bg-brand-success hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition-colors duration-200 flex items-center justify-center gap-2 disabled:bg-gray-500 disabled:cursor-not-allowed">
        <span>ðŸ“„</span>
        <span>Download Excel</span>
      </button>
       <button 
        (click)="publishPayroll()" 
        [disabled]="!reportForSelectedWeek() || reportForSelectedWeek()?.length === 0"
        class="bg-brand-info hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition-colors duration-200 flex items-center justify-center gap-2 disabled:bg-gray-500 disabled:cursor-not-allowed">
        <span>ðŸš€</span>
        <span>Create Payroll Draft</span>
      </button>
    </div>
  </div>

  <div class="mb-4">
    <label for="week-select" class="block text-sm font-medium text-gray-300 mb-1">Select Payroll Week</label>
    <select id="week-select" (change)="selectWeek($event)" [value]="selectedWeekId()" class="bg-gray-800 text-white p-3 rounded-md w-full md:w-1/2 border border-gray-700 focus:ring-2 focus:ring-brand-info outline-none">
      <option value="" disabled>
        {{ availableWeeks().length > 0 ? 'Choose a week...' : 'Upload jobs to see available weeks' }}
      </option>
      @for(week of availableWeeks(); track week.id) {
        <option [value]="week.id">{{ week.display }}</option>
      }
    </select>
  </div>

  @if (selectedWeekId()) {
    <div class="mt-4 mb-6 animate-fade-in">
        <label class="block text-sm font-medium text-gray-300 mb-2">Filter by Day</label>
        <div class="flex flex-wrap gap-2">
            @for (day of dayFilters(); track day.dayIndex) {
                <button (click)="toggleDay(day.dayIndex)" 
                        [class]="selectedDays()[day.dayIndex] ? 'bg-brand-info text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'"
                        class="px-4 py-2 text-sm font-semibold rounded-full transition-colors duration-200 w-24">
                    {{ day.dayName }} {{ day.dayOfMonth }}
                </button>
            }
        </div>
    </div>
  }


  @if (reportForSelectedWeek(); as report) {
    <!-- Report Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-gray-800 p-6 rounded-lg">
            <div class="text-gray-400 text-sm">Total Payout to Technicians</div>
            <div class="text-3xl font-bold text-brand-success">{{ reportSummary().totalPayout | currency }}</div>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg">
            <div class="text-gray-400 text-sm">Final Company Revenue</div>
            <div class="text-3xl font-bold text-white">{{ reportSummary().totalCompanyRevenue | currency }}</div>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg">
            <div class="text-gray-400 text-sm">Total Jobs Completed</div>
            <div class="text-3xl font-bold text-white">{{ reportSummary().totalJobs }}</div>
        </div>
    </div>

    <!-- Detailed Report Table -->
    <div class="bg-gray-800 p-2 rounded-lg">
      <div class="max-h-[600px] overflow-y-auto">
        <table class="w-full text-left">
          <thead class="sticky top-0 bg-gray-900 z-10">
            <tr>
              <th class="p-4 text-sm font-semibold uppercase text-gray-400">Technician</th>
              <th class="p-4 text-sm font-semibold uppercase text-gray-400 text-right">Jobs</th>
              <th class="p-4 text-sm font-semibold uppercase text-gray-400 text-right">Total Revenue</th>
              <th class="p-4 text-sm font-semibold uppercase text-gray-400 text-right">Base Earnings</th>
              <th class="p-4 text-sm font-semibold uppercase text-gray-400 text-right">Adjustments</th>
              <th class="p-4 text-sm font-semibold uppercase text-gray-400 text-right">Final Payout</th>
              <th class="p-4 text-sm font-semibold uppercase text-gray-400 text-right">Co. Revenue</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-700">
            @for (tech of report; track tech.id) {
              @let adjTotal = getAdjustmentsTotal(tech);
              @let baseEarnings = tech.totalEarnings - adjTotal;
              <tr class="hover:bg-gray-700">
                <td class="p-4">
                    <p class="font-medium text-white">{{ tech.name }}</p>
                    <p class="text-sm text-gray-400">#{{ tech.techId }}</p>
                </td>
                <td class="p-4 text-right font-mono text-white">{{ tech.totalJobs }}</td>
                <td class="p-4 text-right font-mono text-gray-300">{{ tech.totalRevenue | currency }}</td>
                <td class="p-4 text-right font-mono text-gray-300">{{ baseEarnings | currency }}</td>
                <td 
                  class="p-4 text-right font-mono"
                  [class.text-gray-500]="adjTotal === 0"
                  [class.text-green-400]="adjTotal > 0"
                  [class.text-red-400]="adjTotal < 0">
                  {{ adjTotal | currency }}
                </td>
                <td class="p-4 text-right font-mono text-brand-success font-bold">{{ tech.totalEarnings | currency }}</td>
                <td class="p-4 text-right font-mono text-white font-bold">{{ tech.companyRevenue | currency }}</td>
              </tr>
            }
             @if (report.length === 0) {
              <tr>
                <td colspan="7" class="text-center text-gray-500 py-16">
                  <h3 class="mt-4 text-xl font-semibold">No Jobs or Adjustments Found</h3>
                  <p class="mt-1">No data matches the selected day filters for this week.</p>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  } @else {
    <div class="text-center py-20 text-gray-500">
      <div class="text-6xl mb-4">
        @if (allJobsProcessed()) { âœ… } @else { ðŸ“Š }
      </div>
      <h2 class="text-3xl font-bold">
        @if (allJobsProcessed()) {
          All Jobs Processed
        } @else if (availableWeeks().length > 0) {
          Select a Week to Begin
        } @else {
          No Report to Display
        }
      </h2>
      <p class="mt-2 text-lg">
        @if (allJobsProcessed()) {
          All available jobs have been added to payroll drafts. Visit 'Payroll History' to finalize them.
        } @else if (availableWeeks().length > 0) {
          Choose a payroll period from the dropdown above to generate a report.
        } @else {
          Upload a job file to generate a weekly report.
        }
      </p>
    </div>
  }
</div>