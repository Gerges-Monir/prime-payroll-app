<div class="animate-fade-in">
  <div class="flex flex-col md:flex-row justify-between md:items-start mb-6 gap-4">
    <div>
      <h2 class="text-xl font-semibold text-slate-800">Process &amp; Analyze</h2>
      <p class="text-slate-500">Select a week and filter by day to view its summary and publish the payroll.</p>
    </div>
    <div class="flex flex-col sm:flex-row gap-2">
      <button 
        (click)="downloadExcel()" 
        [disabled]="!processedReport() || processedReport()?.length === 0"
        class="bg-blue-100 text-blue-800 hover:bg-blue-200 font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 disabled:bg-slate-200 disabled:text-slate-500 disabled:cursor-not-allowed shadow-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
        <span>Download Excel</span>
      </button>
       <button 
        (click)="publishPayroll()" 
        [disabled]="!processedReport() || processedReport()?.length === 0 || isPublishing()"
        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 disabled:bg-slate-300 disabled:cursor-not-allowed shadow-sm">
        @if (isPublishing()) {
          <svg class="animate-spin -ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
          <span>Publishing...</span>
        } @else {
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg>
          <span>Publish Payroll</span>
        }
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end mb-8">
    <div class="lg:col-span-2">
      <label for="week-select" class="block text-sm font-medium text-slate-500 mb-1">Payroll Week</label>
      <select id="week-select" (change)="selectWeek($event)" [value]="selectedWeekId() || ''" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
        <option value="" disabled>
          {{ availableWeeks().length > 0 ? 'Choose a week...' : 'Upload jobs to see available weeks' }}
        </option>
        @for(week of availableWeeks(); track week.id) {
          <option [value]="week.id">{{ week.display }}</option>
        }
      </select>
    </div>
    
    <div class="text-center self-center text-slate-500 font-semibold lg:col-span-1">OR</div>

    <div class="lg:col-span-1">
        <label for="start-date" class="block text-sm font-medium text-slate-500 mb-1">Start Date</label>
        <input id="start-date" type="text" placeholder="MM/DD/YY" [value]="customStartDateInput()" (input)="handleStartDateChange($event)" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
    </div>
    <div class="lg:col-span-1">
        <label for="end-date" class="block text-sm font-medium text-slate-500 mb-1">End Date</label>
        <input id="end-date" type="text" placeholder="MM/DD/YY" [value]="customEndDateInput()" (input)="handleEndDateChange($event)" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
    </div>
  </div>

  <div class="mb-6">
     <label for="tech-select" class="block text-sm font-medium text-slate-500 mb-1">Filter by Employee</label>
     <select id="tech-select" (change)="selectTechnician($event)" [value]="selectedTechId()" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full md:w-1/2 border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
        <option value="all">All Employees</option>
        @for(tech of technicians(); track tech.id) {
            <option [value]="tech.techId">{{ tech.name }} (#{{tech.techId}})</option>
        }
     </select>
  </div>

  @if (processedReport(); as report) {
    <!-- Report Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all">
            <div class="text-slate-500 text-sm">Total Payout to Technicians</div>
            <div class="text-3xl font-bold text-green-600">{{ reportSummary().totalPayout | currency }}</div>
        </div>
        <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all">
            <div class="text-slate-500 text-sm">Final Company Revenue</div>
            <div class="text-3xl font-bold text-slate-800">{{ reportSummary().totalCompanyRevenue | currency }}</div>
        </div>
        <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all">
            <div class="text-slate-500 text-sm">Total Jobs Completed</div>
            <div class="text-3xl font-bold text-slate-800">{{ reportSummary().totalJobs }}</div>
        </div>
    </div>

    <!-- Detailed Report Table -->
    <div class="border border-slate-200 rounded-lg">
      <div class="max-h-[600px] overflow-y-auto">
        <table class="w-full text-left">
          <thead class="sticky top-0 bg-slate-100 z-10 border-b border-slate-200">
            <tr>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500 tracking-wider">Technician</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500 tracking-wider text-right">Jobs</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500 tracking-wider text-right">Total Revenue</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500 tracking-wider text-right">Base Earnings</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500 tracking-wider text-right">Adjustments</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500 tracking-wider text-right">Final Payout</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500 tracking-wider text-right">Co. Revenue</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
            @for (tech of report; track tech.id) {
              @let adjTotal = getAdjustmentsTotal(tech);
              @let baseEarnings = tech.totalEarnings - adjTotal;
              <tr class="hover:bg-slate-50 cursor-pointer" (click)="toggleTechnicianDetails(tech.id)">
                <td class="p-4">
                  <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-slate-500 transition-transform" [class.rotate-90]="selectedTechnicianId() === tech.id">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
                    </svg>
                    <div>
                      <p class="font-medium text-slate-800">{{ tech.name }}</p>
                      <p class="text-sm text-slate-500">#{{ tech.techId }}</p>
                    </div>
                  </div>
                </td>
                <td class="p-4 text-right font-mono text-slate-800">{{ tech.totalJobs }}</td>
                <td class="p-4 text-right font-mono text-slate-800">{{ tech.totalRevenue | currency }}</td>
                <td class="p-4 text-right font-mono text-slate-800">{{ baseEarnings | currency }}</td>
                <td class="p-4 text-right font-mono" [class.text-slate-500]="adjTotal === 0" [class.text-green-600]="adjTotal > 0" [class.text-red-600]="adjTotal < 0">
                  {{ adjTotal | currency }}
                </td>
                <td class="p-4 text-right font-mono text-green-600 font-bold">{{ tech.totalEarnings | currency }}</td>
                <td class="p-4 text-right font-mono text-slate-800 font-bold">{{ tech.companyRevenue | currency }}</td>
              </tr>
              @if (selectedTechnicianId() === tech.id) {
                <tr>
                  <td colspan="7" class="p-0 bg-blue-50">
                    <div class="p-4 animate-fade-in-fast space-y-4">
                      <h4 class="font-semibold text-slate-800">Details for {{tech.name}}</h4>
                      
                      <!-- Jobs Table -->
                      <div>
                        <h5 class="font-medium text-slate-500 text-sm mb-1">Processed Jobs</h5>
                        @if(tech.processedJobs && tech.processedJobs.length > 0) {
                          <div class="max-h-64 overflow-y-auto border border-slate-200 rounded-md">
                            <table class="w-full text-sm text-left bg-white">
                              <thead class="sticky top-0 bg-blue-100 z-10">
                                <tr>
                                  <th class="p-2 font-semibold text-slate-600">Date</th>
                                  <th class="p-2 font-semibold text-slate-600">Task</th>
                                  <th class="p-2 font-semibold text-slate-600 text-right">Revenue</th>
                                  <th class="p-2 font-semibold text-slate-600 text-right">Rate</th>
                                  <th class="p-2 font-semibold text-slate-600 text-right">Earning</th>
                                </tr>
                              </thead>
                              <tbody class="divide-y divide-slate-200">
                                @for(job of tech.processedJobs; track job.id) {
                                  <tr [class.bg-red-50]="job.rateApplied === 0">
                                    <td class="p-2">{{ job.date | date:'shortDate' }}</td>
                                    <td class="p-2">
                                      {{ job.taskCode }} (x{{job.quantity}})
                                      @if (job.isAerialDrop) {
                                        <span class="ml-2 px-2 py-0.5 text-xs font-semibold rounded-full bg-green-100 text-green-800" title="Aerial Drop payout included">Aerial Drop</span>
                                      }
                                    </td>
                                    <td class="p-2 text-right font-mono">{{ job.revenue | currency }}</td>
                                    <td class="p-2 text-right font-mono" [class.text-red-600]="job.rateApplied === 0" [class.font-bold]="job.rateApplied === 0" [class.text-slate-500]="job.rateApplied !== 0">{{ job.rateApplied | currency }}</td>
                                    <td class="p-2 text-right font-mono font-semibold" [class.text-red-600]="job.earning === 0">{{ job.earning | currency }}</td>
                                  </tr>
                                }
                              </tbody>
                            </table>
                          </div>
                        } @else {
                          <p class="text-center text-slate-500 py-4 border border-dashed border-slate-200 rounded-md">No jobs were processed for this technician in this period.</p>
                        }
                      </div>

                      <!-- Adjustments Table -->
                      <div>
                        <h5 class="font-medium text-slate-500 text-sm mb-1">Adjustments</h5>
                        @if(tech.adjustments && tech.adjustments.length > 0) {
                          <div class="max-h-64 overflow-y-auto border border-slate-200 rounded-md">
                            <table class="w-full text-sm text-left bg-white">
                              <thead class="sticky top-0 bg-blue-100 z-10">
                                <tr>
                                  <th class="p-2 font-semibold text-slate-600">Date</th>
                                  <th class="p-2 font-semibold text-slate-600">Type</th>
                                  <th class="p-2 font-semibold text-slate-600">Description</th>
                                  <th class="p-2 font-semibold text-slate-600 text-right">Amount</th>
                                </tr>
                              </thead>
                              <tbody class="divide-y divide-slate-200">
                                @for(adj of tech.adjustments; track adj.id) {
                                  <tr>
                                    <td class="p-2">{{ adj.date | date:'shortDate' }}</td>
                                    <td class="p-2">{{ adj.type }}</td>
                                    <td class="p-2 text-slate-500">{{ adj.description }}</td>
                                    <td class="p-2 text-right font-mono" [class.text-green-600]="adj.amount > 0" [class.text-red-600]="adj.amount < 0">{{ adj.amount | currency }}</td>
                                  </tr>
                                }
                              </tbody>
                            </table>
                          </div>
                        } @else {
                          <p class="text-center text-slate-500 py-4 border border-dashed border-slate-200 rounded-md">No adjustments for this technician in this period.</p>
                        }
                      </div>
                    </div>
                  </td>
                </tr>
              }
            }
             @if (report.length === 0) {
              <tr>
                <td colspan="7" class="text-center text-slate-500 py-16">
                  <h3 class="mt-4 text-xl font-semibold text-slate-800">No Jobs or Adjustments Found</h3>
                  <p class="mt-1">No data matches the selected filters.</p>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  } @else {
    <div class="text-center py-20 text-slate-500 bg-slate-100/70 rounded-lg border-2 border-dashed border-slate-200">
        @if (allJobsProcessed()) { 
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
        } @else { 
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-sky-500" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z" /></svg>
        }
      <h2 class="text-2xl font-bold text-slate-800 mt-4">
        @if (allJobsProcessed()) {
          All Jobs Processed
        } @else if (availableWeeks().length > 0) {
          Select a Date Range to Begin
        } @else {
          No Report to Display
        }
      </h2>
      <p class="mt-2 text-lg">
        @if (allJobsProcessed()) {
          All available jobs have been added to payroll drafts. Visit Payroll History to view them.
        } @else if (availableWeeks().length > 0) {
          Choose a pre-defined week or set a custom date range to see a payroll summary.
        } @else {
          Upload a payroll file to get started.
        }
      </p>
    </div>
  }
</div>

@if (showPublishConfirm()) {
  <app-confirmation-modal 
    title="Confirm Payroll Publication"
    [message]="'Are you sure you want to finalize the payroll for ' + (dateRange().start | date:'mediumDate') + ' to ' + (dateRange().end | date:'mediumDate') + '? This will make it visible to employees and remove the processed jobs from this period.'"
    confirmText="Finalize & Publish"
    confirmStyle="success"
    (confirmed)="handlePublish($event)">
  </app-confirmation-modal>
}