<div class="animate-fade-in">
  <div class="flex justify-between items-start mb-4">
    <div>
        <h2 class="text-xl font-semibold text-slate-800">Adjustments</h2>
        <p class="text-slate-500">Manage one-time, recurring, and loan-based payroll adjustments.</p>
    </div>
  </div>

  <!-- Tabs -->
  <div class="mb-6">
    <div class="border-b border-slate-200">
      <nav class="-mb-px flex space-x-4" aria-label="Tabs">
        <button (click)="selectTab('oneTime')" [class]="activeTab() === 'oneTime' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-800'" class="whitespace-nowrap py-3 px-2 border-b-2 font-medium text-base">One-Time Adjustments</button>
        <button (click)="selectTab('loans')" [class]="activeTab() === 'loans' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-800'" class="whitespace-nowrap py-3 px-2 border-b-2 font-medium text-base">Loan Management</button>
        <button (click)="selectTab('recurring')" [class]="activeTab() === 'recurring' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-800'" class="whitespace-nowrap py-3 px-2 border-b-2 font-medium text-base">Recurring Deductions</button>
      </nav>
    </div>
  </div>

  <!-- Tab Content -->
  <div>
    @if (activeTab() === 'oneTime') {
      <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
        <div>
          <h3 class="text-lg font-semibold text-slate-800">Unprocessed Adjustments</h3>
          <p class="text-slate-500 text-sm mt-1">Add or remove one-off bonuses, chargebacks, and manual loan payments.</p>
        </div>
        <button (click)="openModal('oneTime')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 shadow-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
          <span>Add Adjustment</span>
        </button>
      </div>
      <div class="border border-slate-200 rounded-lg max-h-[600px] overflow-y-auto">
        <table class="w-full text-left">
           <thead class="sticky top-0 bg-slate-100 z-10">
            <tr>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500">Technician</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500">Date</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500">Type</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500">Description</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500 text-right">Amount</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500 text-center">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
             @for(adj of unprocessedAdjustments(); track adj.id) {
                <tr class="hover:bg-slate-50 group">
                    <td class="p-4 font-medium text-slate-800">{{ getTechName(adj.techId) }}</td>
                    <td class="p-4 text-slate-800">{{ adj.date | date:'shortDate' }}</td>
                    <td class="p-4 text-slate-800">
                      <span class="px-2 py-1 text-xs font-semibold rounded-full" [class.bg-green-100]="adj.amount > 0" [class.text-green-800]="adj.amount > 0" [class.bg-red-100]="adj.amount < 0" [class.text-red-800]="adj.amount < 0">
                        {{ adj.type }}
                      </span>
                    </td>
                    <td class="p-4 text-slate-500">{{ adj.description }}</td>
                    <td class="p-4 font-mono text-right font-semibold" [class.text-green-600]="adj.amount > 0" [class.text-red-600]="adj.amount < 0">{{ adj.amount | currency }}</td>
                    <td class="p-4 text-center">
                      <button (click)="deleteOneTimeAdjustment(adj)" class="bg-red-100 text-red-600 hover:bg-red-600 hover:text-white font-bold py-1 px-3 rounded-md text-sm">
                        Delete
                      </button>
                    </td>
                </tr>
             } @empty {
                <tr><td colspan="6" class="text-center text-slate-500 py-16">No unprocessed one-time adjustments.</td></tr>
             }
          </tbody>
        </table>
       </div>
    }

    @if (activeTab() === 'loans') {
      <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
        <div>
          <h3 class="text-lg font-semibold text-slate-800">Loan Profiles</h3>
          <p class="text-slate-500 text-sm mt-1">Manage employee loans. Payments are added manually from the One-Time Adjustments tab.</p>
        </div>
        <button (click)="openModal('loan')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 shadow-sm">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
          <span>Add New Loan</span>
        </button>
      </div>
       <div class="space-y-6">
        @for(group of loansByTechnician(); track group.user.id) {
          <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
            <h4 class="text-lg font-semibold text-slate-800 mb-3">{{ group.user.name }}</h4>
            <div class="overflow-x-auto">
              <table class="w-full text-left text-sm">
                <thead class="border-b border-slate-200">
                  <tr>
                    <th class="p-2 font-semibold text-slate-500">Date</th>
                    <th class="p-2 font-semibold text-slate-500">Description</th>
                    <th class="p-2 font-semibold text-slate-500">Total Amount</th>
                    <th class="p-2 font-semibold text-slate-500 min-w-[200px]">Balance</th>
                    <th class="p-2 font-semibold text-slate-500 text-center">Status</th>
                    <th class="p-2 font-semibold text-slate-500 text-center">Actions</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                  @for(loan of group.loans; track loan.id) {
                    <tr class="hover:bg-slate-50">
                        <td class="p-2 text-slate-500">{{ loan.date | date:'shortDate' }}</td>
                        <td class="p-2 text-slate-800">
                          {{ loan.description }}
                          @if (loan.isTaxable) {
                            <span class="ml-2 px-2 py-0.5 text-xs font-semibold rounded-full bg-amber-100 text-amber-800" title="This loan is reported as income for tax purposes.">Taxable</span>
                          }
                        </td>
                        <td class="p-2 font-mono text-slate-500">{{ loan.totalAmount | currency }}</td>
                        <td class="p-2">
                            <div class="flex items-center gap-2">
                                <div class="w-full bg-slate-200 rounded-full h-2.5">
                                    <div class="bg-blue-600 h-2.5 rounded-full" [style.width.%]="(loan.totalAmount - loan.remainingAmount) / loan.totalAmount * 100"></div>
                                </div>
                                <span class="font-mono text-slate-800">{{ loan.remainingAmount | currency }}</span>
                            </div>
                        </td>
                        <td class="p-2 text-center">
                          <span class="px-2 py-1 text-xs font-semibold rounded-full" [class.bg-green-100]="loan.isActive" [class.text-green-800]="loan.isActive" [class.bg-slate-200]="!loan.isActive" [class.text-slate-600]="!loan.isActive">
                            {{ loan.isActive ? 'Active' : 'Paid Off' }}
                          </span>
                        </td>
                        <td class="p-2 text-center">
                            <button (click)="openEditLoanModal(loan)" class="bg-slate-100 text-slate-700 hover:bg-slate-200 font-bold py-1 px-3 rounded-md text-xs">Edit</button>
                        </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        } @empty {
          <div class="text-center text-slate-500 py-16 border-2 border-dashed border-slate-200 rounded-lg">
            No active or past loans found.
          </div>
        }
       </div>
    }

     @if (activeTab() === 'recurring') {
      <div class="flex justify-between items-center mb-4">
        <p class="text-slate-800">Manage fixed deductions that apply to every payroll.</p>
        <button (click)="openModal('recurring')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm">Add Recurring</button>
      </div>
       <div class="border border-slate-200 rounded-lg max-h-[600px] overflow-y-auto">
        <table class="w-full text-left">
           <thead class="sticky top-0 bg-slate-100 z-10">
            <tr>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500">Technician</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500">Description</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500 text-right">Weekly Amount</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500 text-center">Status</th>
               <th class="p-4 text-sm font-semibold uppercase text-slate-500 text-center">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
             @for(adj of recurringAdjustments(); track adj.id) {
                <tr class="hover:bg-slate-50">
                    <td class="p-4 font-medium text-slate-800">{{ getTechName(adj.techId) }}</td>
                    <td class="p-4 text-slate-800">{{ adj.description }}</td>
                    <td class="p-4 font-mono text-right text-red-600">{{ adj.weeklyAmount | currency }}</td>
                    <td class="p-4 text-center">
                        <button (click)="toggleRecurringStatus(adj)" [class]="adj.isActive ? 'bg-green-600 hover:bg-green-700' : 'bg-amber-500 hover:bg-amber-600'" class="text-white font-bold py-1 px-3 rounded-full text-sm w-20">
                          {{ adj.isActive ? 'Active' : 'Paused' }}
                        </button>
                    </td>
                    <td class="p-4 text-center">
                        <button (click)="openEditRecurringModal(adj)" class="bg-blue-100 text-blue-800 hover:bg-blue-200 font-bold py-1 px-3 rounded-md text-sm">Edit</button>
                    </td>
                </tr>
             } @empty {
                <tr><td colspan="5" class="text-center text-slate-500 py-16">No recurring adjustments configured.</td></tr>
             }
          </tbody>
        </table>
       </div>
    }
  </div>
</div>

<!-- Modals -->
@if (showModal(); as modalType) {
  <div class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in p-4">
    <!-- One-Time Adjustment Modal -->
    @if (modalType === 'oneTime') {
      <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-lg m-4 border border-slate-200">
        <h2 class="text-2xl font-bold mb-6 text-slate-800">Add One-Time Adjustment</h2>
        <form [formGroup]="oneTimeForm" (ngSubmit)="saveOneTime()">
          <div class="space-y-4">
            <select formControlName="techId" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none"><option value="" disabled>Select Employee</option>@for(u of users(); track u.id){<option [value]="u.techId">{{u.name}}</option>}</select>
            <input formControlName="date" type="date" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
            <select formControlName="type" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
                <option>Bonus</option>
                <option>Chargeback</option>
                <option>Loan Payment</option>
                <option value="Fee">Meter/Ladder/Software Fee</option>
                <option value="RepeatTC">Repeat TC</option>
            </select>
            @if (oneTimeForm.get('type')?.value === 'Loan Payment') {
                <div class="animate-fade-in">
                    <select formControlName="loanId" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
                        <option [ngValue]="null" disabled>Select an active loan...</option>
                        @for (loan of userLoans(); track loan.id) {
                            <option [value]="loan.id">{{loan.description}} ({{loan.remainingAmount | currency}} remaining)</option>
                        }
                    </select>
                    @if (userLoans().length === 0 && oneTimeForm.get('techId')?.value) {
                       <p class="text-xs text-amber-700 mt-1">This employee has no active loans.</p>
                    }
                </div>
            }
            <input formControlName="description" placeholder="Description (e.g., Performance Bonus)" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
            <input formControlName="amount" type="number" step="0.01" placeholder="Amount (e.g., 50.00)" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
          </div>
          <div class="flex justify-end gap-4 mt-8">
            <button type="button" (click)="closeModal()" class="bg-slate-100 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-200 transition-colors">Cancel</button>
            <button type="submit" [disabled]="oneTimeForm.invalid || isSaving()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg disabled:bg-slate-300 disabled:cursor-not-allowed">Save</button>
          </div>
        </form>
      </div>
    }
    <!-- Loan Modal -->
    @if (modalType === 'loan') {
      <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-lg m-4 border border-slate-200">
        <h2 class="text-2xl font-bold mb-6 text-slate-800">Create New Loan</h2>
        <form [formGroup]="loanForm" (ngSubmit)="saveLoan()">
          <div class="space-y-4">
            <select formControlName="techId" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none"><option value="" disabled>Select Employee</option>@for(u of users(); track u.id){<option [value]="u.techId">{{u.name}}</option>}</select>
            <input formControlName="date" type="date" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
            <input formControlName="description" placeholder="Loan Description (e.g., Tool Advance)" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
            <input formControlName="totalAmount" type="number" step="0.01" placeholder="Total Loan Amount" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
            <div class="flex items-center gap-2 pt-2">
              <input id="isTaxable" type="checkbox" formControlName="isTaxable" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <label for="isTaxable" class="text-sm font-medium text-slate-700">Include this loan in tax calculations (1099)</label>
            </div>
          </div>
          <div class="flex justify-end gap-4 mt-8">
            <button type="button" (click)="closeModal()" class="bg-slate-100 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-200 transition-colors">Cancel</button>
            <button type="submit" [disabled]="loanForm.invalid || isSaving()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg disabled:bg-slate-300 disabled:cursor-not-allowed">Save Loan</button>
          </div>
        </form>
      </div>
    }
    <!-- Edit Loan Modal -->
    @if (modalType === 'editLoan' && loanToEdit(); as loan) {
      <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-lg m-4 border border-slate-200">
        <h2 class="text-2xl font-bold mb-6 text-slate-800">Edit Loan for {{ getTechName(loan.techId) }}</h2>
        <form [formGroup]="editLoanForm" (ngSubmit)="updateLoan()">
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-500 mb-1">Total Amount</label>
                  <input [value]="loan.totalAmount | currency" disabled class="bg-slate-100 text-slate-500 p-3 rounded-md w-full border border-slate-300 cursor-not-allowed">
                </div>
                 <div>
                  <label class="block text-sm font-medium text-slate-500 mb-1">Remaining Balance</label>
                  <input [value]="loan.remainingAmount | currency" disabled class="bg-slate-100 text-slate-500 p-3 rounded-md w-full border border-slate-300 cursor-not-allowed">
                </div>
            </div>
             <div>
              <label for="edit-loan-desc" class="block text-sm font-medium text-slate-800 mb-1">Description</label>
              <input id="edit-loan-desc" formControlName="description" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
            </div>
          </div>
          <div class="flex justify-end gap-4 mt-8">
            <button type="button" (click)="closeModal()" class="bg-slate-100 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-200 transition-colors">Cancel</button>
            <button type="submit" [disabled]="editLoanForm.invalid || isSaving()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg disabled:bg-slate-300 disabled:cursor-not-allowed">Update Loan</button>
          </div>
        </form>
      </div>
    }
     <!-- Recurring Deduction Modal -->
    @if (modalType === 'recurring') {
       <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-lg m-4 border border-slate-200">
        <h2 class="text-2xl font-bold mb-6 text-slate-800">Add Recurring Deduction</h2>
        <form [formGroup]="recurringForm" (ngSubmit)="saveRecurring()">
          <div class="space-y-4">
            <select formControlName="techId" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none"><option value="" disabled>Select Employee</option>@for(u of users(); track u.id){<option [value]="u.techId">{{u.name}}</option>}</select>
            <input formControlName="description" placeholder="Description (e.g., Rent, Tool Fee)" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
            <input formControlName="weeklyAmount" type="number" step="0.01" placeholder="Weekly Deduction Amount" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
          </div>
          <div class="flex justify-end gap-4 mt-8">
            <button type="button" (click)="closeModal()" class="bg-slate-100 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-200 transition-colors">Cancel</button>
            <button type="submit" [disabled]="recurringForm.invalid || isSaving()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg disabled:bg-slate-300 disabled:cursor-not-allowed">Save</button>
          </div>
        </form>
      </div>
    }
     <!-- Edit Recurring Deduction Modal -->
    @if (modalType === 'editRecurring' && recurringToEdit(); as adj) {
      <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-lg m-4 border border-slate-200">
        <h2 class="text-2xl font-bold mb-6 text-slate-800">Edit Deduction for {{ getTechName(adj.techId) }}</h2>
        <form [formGroup]="editRecurringForm" (ngSubmit)="updateRecurring()">
          <div class="space-y-4">
             <div>
              <label for="edit-recurring-desc" class="block text-sm font-medium text-slate-800 mb-1">Description</label>
              <input id="edit-recurring-desc" formControlName="description" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
            </div>
             <div>
              <label for="edit-recurring-amount" class="block text-sm font-medium text-slate-800 mb-1">Weekly Deduction Amount</label>
              <input id="edit-recurring-amount" formControlName="weeklyAmount" type="number" step="0.01" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none">
            </div>
          </div>
          <div class="flex justify-end gap-4 mt-8">
            <button type="button" (click)="closeModal()" class="bg-slate-100 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-200 transition-colors">Cancel</button>
            <button type="submit" [disabled]="editRecurringForm.invalid || isSaving()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg disabled:bg-slate-300 disabled:cursor-not-allowed">Update</button>
          </div>
        </form>
      </div>
    }
  </div>
}

<!-- Delete Adjustment Confirmation Modal -->
@if (showDeleteAdjustmentConfirm()) {
  <app-confirmation-modal 
    title="Confirm Adjustment Deletion"
    [message]="deleteMessage()"
    confirmText="Delete Adjustment"
    confirmStyle="danger"
    (confirmed)="handleAdjustmentDelete($event)">
  </app-confirmation-modal>
}