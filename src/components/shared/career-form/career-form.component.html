@if (isPreview()) {
  <div class="absolute top-0 left-0 right-0 bg-amber-400 text-amber-900 text-center py-1.5 text-sm font-semibold z-20">
    Preview Mode
  </div>
}
@if (submissionState() === 'form') {
    <form [formGroup]="careerForm" (ngSubmit)="onSubmit()" class="bg-white rounded-b-xl">
        <!-- HEADER: Progress Bar (Sticky) -->
        <div class="px-8 pt-8 pb-4 sticky top-0 bg-white z-10 border-b border-slate-200">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-semibold text-slate-800">
                    Step {{ currentStep() }} of {{ totalSteps() }}: 
                    @switch (currentStep()) {
                        @case (1) { Personal Info }
                        @case (2) { Details & Resume }
                        @case (3) { Additional Questions }
                    }
                </span>
                <span class="text-sm font-medium text-slate-500">{{ ((currentStep() / totalSteps()) * 100).toFixed(0) }}%</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2">
                <div class="bg-blue-600 h-2 rounded-full transition-all duration-500" [style.width.%]="(currentStep() / totalSteps()) * 100"></div>
            </div>
        </div>

        <!-- CONTENT: Form Fields -->
        <div class="p-8 space-y-6">
            <!-- Step 1: Personal Info -->
            @if (currentStep() === 1) {
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 animate-fade-in">
                    <div>
                        <label for="career-name" class="block text-sm font-medium text-slate-700 mb-1">Full Name <span class="text-red-500">*</span></label>
                        <input type="text" id="career-name" formControlName="name" class="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 outline-none transition" placeholder="John Doe">
                        @if (careerForm.get('name')?.invalid && careerForm.get('name')?.touched) {
                            <p class="text-red-500 text-xs mt-1">Full name is required.</p>
                        }
                    </div>
                    <div>
                        <label for="career-position" class="block text-sm font-medium text-slate-700 mb-1">Position Applying For</label>
                        <input type="text" id="career-position" formControlName="position" class="w-full p-3 bg-slate-200 text-slate-500 border border-slate-300 rounded-lg outline-none transition cursor-not-allowed" readonly>
                    </div>
                    <div>
                        <label for="career-email" class="block text-sm font-medium text-slate-700 mb-1">Email Address <span class="text-red-500">*</span></label>
                        <input type="email" id="career-email" formControlName="email" class="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 outline-none transition" placeholder="you@example.com">
                        @if (careerForm.get('email')?.touched) {
                            @if (careerForm.get('email')?.hasError('required')) {
                                <p class="text-red-500 text-xs mt-1">Email address is required.</p>
                            }
                            @if (careerForm.get('email')?.hasError('email')) {
                                <p class="text-red-500 text-xs mt-1">Please enter a valid email address.</p>
                            }
                        }
                    </div>
                    <div>
                        <label for="career-phone" class="block text-sm font-medium text-slate-700 mb-1">Phone Number <span class="text-red-500">*</span></label>
                        <input type="tel" id="career-phone" formControlName="phone" class="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 outline-none transition" placeholder="(555) 123-4567">
                        @if (careerForm.get('phone')?.invalid && careerForm.get('phone')?.touched) {
                            <p class="text-red-500 text-xs mt-1">Phone number is required.</p>
                        }
                    </div>
                </div>
            }
            <!-- Step 2: Details -->
            @if (currentStep() === 2) {
                <div class="space-y-6 animate-fade-in">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-8">
                        <fieldset>
                            <legend class="block text-sm font-medium text-slate-700 mb-2">Do you have a valid Driver's License? <span class="text-red-500">*</span></legend>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer p-2 rounded-md hover:bg-slate-100"><input type="radio" formControlName="hasDriversLicense" [value]="true" class="h-4 w-4 text-blue-600 focus:ring-blue-500"> Yes</label>
                                <label class="flex items-center gap-2 cursor-pointer p-2 rounded-md hover:bg-slate-100"><input type="radio" formControlName="hasDriversLicense" [value]="false" class="h-4 w-4 text-blue-600 focus:ring-blue-500"> No</label>
                            </div>
                            @if (careerForm.get('hasDriversLicense')?.invalid && careerForm.get('hasDriversLicense')?.touched) {
                                <p class="text-red-500 text-xs mt-1">Please select an option.</p>
                            }
                        </fieldset>
                        <fieldset>
                            <legend class="block text-sm font-medium text-slate-700 mb-2">Are you willing to travel for work? <span class="text-red-500">*</span></legend>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer p-2 rounded-md hover:bg-slate-100"><input type="radio" formControlName="willingToTravel" [value]="true" class="h-4 w-4 text-blue-600 focus:ring-blue-500"> Yes</label>
                                <label class="flex items-center gap-2 cursor-pointer p-2 rounded-md hover:bg-slate-100"><input type="radio" formControlName="willingToTravel" [value]="false" class="h-4 w-4 text-blue-600 focus:ring-blue-500"> No</label>
                            </div>
                             @if (careerForm.get('willingToTravel')?.invalid && careerForm.get('willingToTravel')?.touched) {
                                <p class="text-red-500 text-xs mt-1">Please select an option.</p>
                            }
                        </fieldset>
                         <fieldset>
                            <legend class="block text-sm font-medium text-slate-700 mb-2">Are you fluent in English? <span class="text-red-500">*</span></legend>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer p-2 rounded-md hover:bg-slate-100"><input type="radio" formControlName="isFluentInEnglish" [value]="true" class="h-4 w-4 text-blue-600 focus:ring-blue-500"> Yes</label>
                                <label class="flex items-center gap-2 cursor-pointer p-2 rounded-md hover:bg-slate-100"><input type="radio" formControlName="isFluentInEnglish" [value]="false" class="h-4 w-4 text-blue-600 focus:ring-blue-500"> No</label>
                            </div>
                            @if (careerForm.get('isFluentInEnglish')?.invalid && careerForm.get('isFluentInEnglish')?.touched) {
                                <p class="text-red-500 text-xs mt-1">Please select an option.</p>
                            }
                        </fieldset>
                    </div>
                     <div>
                        <label for="career-resume" class="block text-sm font-medium text-slate-700 mb-1">Link to Resume (Optional)</label>
                        <input type="url" id="career-resume" formControlName="resumeLink" class="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 outline-none transition" placeholder="e.g., LinkedIn profile or Google Drive link">
                    </div>
                    <div>
                        <label for="career-resume-upload" class="block text-sm font-medium text-slate-700 mb-1">Upload Resume (Optional)</label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md">
                            <div class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                <div class="flex text-sm text-slate-600">
                                    <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                        <span>Upload a file</span>
                                        <input id="file-upload" name="file-upload" type="file" class="sr-only" (change)="onFileSelected($event)">
                                    </label>
                                    <p class="pl-1">or drag and drop</p>
                                </div>
                                <p class="text-xs text-slate-500">PNG, JPG, PDF up to 2MB</p>
                                @if (selectedFileName(); as fileName) {
                                    <p class="text-sm font-semibold text-green-600">{{ fileName }} selected</p>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
            <!-- Step 3: Custom Questions -->
            @if (currentStep() === 3) {
                <div class="space-y-6 animate-fade-in" formArrayName="customAnswers">
                    @for (question of customAnswers.controls; track $index) {
                        <div [formGroupName]="$index">
                            <label [for]="'question-' + $index" class="block text-sm font-medium text-slate-700 mb-1">
                                {{ question.get('question')?.value }} <span class="text-red-500">*</span>
                            </label>
                            <textarea [id]="'question-' + $index" formControlName="answer" rows="4" class="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 outline-none transition"></textarea>
                            @if (question.get('answer')?.invalid && question.get('answer')?.touched) {
                                <p class="text-red-500 text-xs mt-1">An answer is required.</p>
                            }
                        </div>
                    }
                </div>
            }
        </div>
        
        <!-- FOOTER: Navigation (Sticky) -->
        <div class="p-6 border-t border-slate-200 flex justify-between items-center sticky bottom-0 bg-white z-10">
            <div>
                @if (currentStep() > 1) {
                    <button type="button" (click)="prevStep()" class="px-6 py-2 bg-slate-200 text-slate-800 font-semibold rounded-lg hover:bg-slate-300 transition duration-300">
                        Back
                    </button>
                }
            </div>
            <div>
                @if (currentStep() < totalSteps()) {
                     <button type="button" (click)="nextStep()" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:-translate-y-0.5">
                        Next Step
                    </button>
                }
                @if (currentStep() === totalSteps()) {
                    <button type="submit" [disabled]="isPreview() || isSending()" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 transform hover:-translate-y-0.5 disabled:bg-slate-300 disabled:cursor-not-allowed flex items-center justify-center min-w-[150px]">
                        @if (isSending()) {
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span>Submitting...</span>
                        } @else {
                            <span>Submit Application</span>
                        }
                    </button>
                }
            </div>
        </div>
    </form>
} @else {
    <div class="p-8 flex flex-col items-center justify-center text-center flex-grow min-h-0">
        <div class="w-[300px] h-[150px] overflow-visible mb-6">
            <svg class="w-full h-full" viewBox="0 0 240 100">
                <path id="success-cable-line" d="M0 50 C 40 50, 60 50, 80 50" stroke="#93c5fd" stroke-width="3" fill="none"/>
                <g id="success-modem-group">
                    <g id="success-cable-plug">
                        <rect x="80" y="45" width="15" height="10" rx="2" fill="#93c5fd"/>
                    </g>
                    <rect x="110" y="35" width="70" height="30" rx="5" fill="#dbeafe" stroke="#93c5fd" stroke-width="1.5"/>
                    <rect x="115" y="55" width="60" height="4" rx="2" fill="#bfdbfe"/>
                    <circle id="success-status-light" cx="170" cy="43" r="3" fill="#f87171"/>
                    <g id="success-wifi-symbol" transform="translate(145, 30)">
                        <path id="success-wifi-3" d="M -20 -5 A 25 25 0 0 1 20 -5" stroke="#4ade80" stroke-width="3" stroke-linecap="round" fill="none"/>
                        <path id="success-wifi-2" d="M -12 -5 A 15 15 0 0 1 12 -5" stroke="#4ade80" stroke-width="3" stroke-linecap="round" fill="none"/>
                        <path id="success-wifi-1" d="M -4 -5 A 5 5 0 0 1 4 -5" stroke="#4ade80" stroke-width="3" stroke-linecap="round" fill="none"/>
                    </g>
                </g>
            </svg>
        </div>

        <h3 class="text-3xl font-bold text-green-600 mb-2">Application Submitted!</h3>
        <p class="text-slate-600 max-w-md mx-auto">Thank you for your interest in joining our team. We have received your application and will review it shortly. If your qualifications match our needs, we will be in touch.</p>
        <button (click)="handleClose()" class="mt-8 px-8 py-3 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105">
            Close
        </button>
    </div>
}
