<div class="animate-fade-in">
  <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
    <div>
      <h2 class="text-xl font-semibold text-slate-800">Individual Performance Reports</h2>
      <p class="text-slate-500">Upload and manage weekly performance reports for each employee.</p>
      <p class="text-sm text-amber-700 mt-2 bg-amber-50 p-3 rounded-lg border border-amber-200">
        <strong>Note:</strong> This section is for managing single, ad-hoc reports. Uploaded images here are for one-time use and are <strong>not</strong> saved as master datasets for reuse. To manage reusable datasets, please go to the 'Performance Datasets' page.
      </p>
    </div>
     <button (click)="publishAllForWeek()" [disabled]="!hasDraftsForWeek()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors shadow-sm disabled:bg-slate-300 disabled:cursor-not-allowed">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3.105 6.187a.75.75 0 0 1 1.06 0l4.652 4.652 8.06-8.06a.75.75 0 0 1 1.06 1.06l-8.59 8.59a.75.75 0 0 1-1.06 0l-5.182-5.182a.75.75 0 0 1 0-1.06Z" /></svg>
      <span>Publish All for Week</span>
    </button>
  </div>

  <!-- New Chart Generation Section -->
  <div class="bg-slate-100/50 p-6 rounded-lg border border-slate-200 mb-8 shadow-sm">
    <div class="flex items-center gap-2">
        <h3 class="text-lg font-semibold text-slate-800">Generate Reports from Excel</h3>
        <button (click)="showFormatHelp.set(true)" type="button" class="text-slate-400 hover:text-blue-600" title="View expected file format">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
        </button>
    </div>
    <p class="text-sm text-slate-500 mt-1">Upload your weekly metrics file (.xlsx) to automatically generate and apply performance charts for the selected week below.</p>
    <div class="mt-4 flex flex-col sm:flex-row gap-4 items-start sm:items-center">
        <input type="file" #metricsFileInput (change)="onMetricsFileSelected($event)" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-slate-100 file:text-blue-600 hover:file:bg-blue-100"/>
        <button (click)="processAndGenerateCharts()" [disabled]="!metricsFile() || isProcessingFile() || !selectedWeek()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 disabled:bg-slate-300 disabled:cursor-not-allowed w-full sm:w-auto flex-shrink-0">
            @if (isProcessingFile()) {
                <svg class="animate-spin -ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span>Processing...</span>
            } @else {
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5a1.5 1.5 0 0 1 3 0V4a1 1 0 0 0 1 1h3a1 1 0 0 1 1 1v9a1 1 0 0 1-1-1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h3a1 1 0 0 0 1-1v-.5a1.5 1.5 0 0 1 3 0V4H7v-.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 .5.5V4h-3v-.5ZM3 8v7h14V8H3Zm2-2h10v1H5V6Z" /></svg>
                <span>Generate Charts</span>
            }
        </button>
    </div>
     @if (!selectedWeek()) {
        <p class="text-xs text-amber-700 mt-2">Please select a week below before generating charts.</p>
     }
  </div>


  <!-- Week Selector -->
  <div class="mb-6">
    <label for="week-input-perf" class="block text-sm font-medium text-slate-500 mb-1">Select Week</label>
    <input
      id="week-input-perf"
      type="text"
      placeholder="MM/DD/YY"
      [ngModel]="dateInput()"
      (ngModelChange)="dateInput.set($event)"
      class="bg-slate-50 text-slate-800 p-3 rounded-md w-full md:w-1/2 lg:w-1/3 border border-slate-200 focus:ring-2 focus:ring-blue-500/50 outline-none"
    >
    <p class="text-xs text-slate-500 mt-1">Enter any date within the desired week.</p>
  </div>
  
  @if (selectedWeek()) {
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
      @for (data of employeeReportData(); track data.user.id) {
        @let isPublished = data.report?.status === 'published';
        <div class="bg-white p-4 rounded-lg border border-slate-200 space-y-4 shadow-sm hover:shadow-md transition-shadow">
          <!-- User Header -->
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-slate-100 text-blue-800 flex items-center justify-center font-bold text-sm shrink-0 shadow-md">
              {{ getInitials(data.user.name) }}
            </div>
            <div class="flex-grow">
              <p class="font-semibold text-slate-800">{{ data.user.name }}</p>
              <p class="text-xs text-slate-500">#{{ data.user.techId }}</p>
            </div>
            @if(data.report) {
              <span class="px-2 py-1 text-xs font-semibold rounded-full" 
                    [class.bg-green-100]="isPublished" [class.text-green-800]="isPublished"
                    [class.bg-amber-100]="!isPublished" [class.text-amber-800]="!isPublished">
                {{ isPublished ? 'Published' : 'Draft' }}
              </span>
            }
          </div>
          
          <!-- Image Preview/Upload -->
          <div class="aspect-video bg-slate-100 rounded border-2 border-dashed border-slate-200 flex items-center justify-center relative overflow-hidden">
            @if(data.previewUrl(); as url) {
                <img [src]="url" alt="Performance Report Preview" class="w-full h-full object-contain">
            } @else {
                <span class="text-slate-500 text-sm">No Report Uploaded</span>
            }
          </div>

          <!-- Notes -->
           <div>
              <label [for]="'notes-' + data.user.id" class="block text-sm font-medium text-slate-500 mb-1">Notes</label>
              <textarea [id]="'notes-' + data.user.id" [(ngModel)]="data.notes" rows="3" placeholder="Add optional notes about this performance report..." class="bg-white text-slate-800 p-2 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none transition-colors placeholder:text-slate-400 text-sm"></textarea>
            </div>
          
          <!-- Actions -->
          <div class="flex gap-2 justify-end">
            <label class="bg-slate-50 hover:bg-slate-100 text-slate-800 border border-slate-200 font-bold py-2 px-4 rounded-lg cursor-pointer text-sm">
                {{ data.previewUrl() ? 'Change Image' : 'Upload Image' }}
                <input type="file" (change)="onFileSelected($event, data)" accept="image/*" class="hidden">
            </label>
            @if (data.report) {
                 <button (click)="deleteReport(data)" class="bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 font-bold py-2 px-4 rounded-lg text-sm">
                   {{ data.report?.status === 'published' ? 'Unpublish' : 'Delete' }}
                 </button>
            }
            <button (click)="saveReport(data)" [disabled]="!data.previewUrl()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-slate-300 disabled:cursor-not-allowed text-sm">
              {{ data.report ? 'Save Changes' : 'Save as Draft' }}
            </button>
          </div>
        </div>
      }
    </div>
  } @else {
     <div class="text-center py-20 text-slate-500 bg-slate-100/70 rounded-lg border-2 border-dashed border-slate-200">
      <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-sky-500" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18" /></svg>
      <h2 class="text-2xl font-bold text-slate-800 mt-4">Select a Week</h2>
      <p class="mt-2 text-lg">Choose a payroll week from the dropdown to manage performance reports.</p>
    </div>
  }
</div>

<!-- Hidden container for generating charts -->
<div class="fixed -top-[9999px] -left-[9999px] z-[-1] opacity-0 pointer-events-none">
  @if(chartsToGenerate(); as charts) {
    @for(chart of charts; track chart.techData['Tech #']) {
      <div [id]="'chart-gen-' + chart.techData['Tech #']">
        <app-performance-chart [techData]="chart.techData" [perfData]="chart.perfData"></app-performance-chart>
      </div>
    }
  }
</div>

<!-- Format Help Modal -->
@if (showFormatHelp()) {
  <div class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in p-4" (click)="showFormatHelp.set(false)">
    <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-3xl border border-slate-200 max-h-[90vh] flex flex-col" (click)="$event.stopPropagation()">
      <div class="flex justify-between items-start flex-shrink-0">
        <h2 class="text-xl font-bold mb-4 text-slate-800">Expected Performance Metrics Format</h2>
        <button (click)="showFormatHelp.set(false)" class="text-slate-500 hover:text-slate-800">&times;</button>
      </div>
      <div class="flex-grow overflow-y-auto pr-4">
        <p class="text-sm text-slate-600 mb-4">The file parser is flexible and tries to find columns based on common names. The first sheet should contain technician data.</p>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h3 class="font-semibold text-slate-700 mb-2">Core Columns (Required)</h3>
                <ul class="list-disc list-inside space-y-1 text-sm text-slate-600">
                    <li><strong>Tech #:</strong> Unique identifier for the technician.</li>
                    <li><strong>Name:</strong> Full name of the technician.</li>
                    <li>At least one metric column (e.g., 'Positive Completion %', 'Jobs').</li>
                </ul>
            </div>
            <div>
                <h3 class="font-semibold text-slate-700 mb-2">Optional Info Columns</h3>
                <ul class="list-disc list-inside space-y-1 text-sm text-slate-600">
                    <li>Vendor, Market, Region</li>
                    <li>Tier, RANK, TOTAL RATING</li>
                </ul>
            </div>
        </div>

        <h3 class="font-semibold text-slate-700 mt-6 mb-2">Recognized Metric Columns</h3>
        <p class="text-sm text-slate-600 mb-4">Provide either the percentage columns directly, or the raw data columns for the system to calculate the percentages.</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
            <div>
                <h4 class="font-medium text-slate-600 border-b mb-2 pb-1">Percentage-Based Metrics</h4>
                <ul class="list-disc list-inside space-y-1">
                    <li>Positive Completion %</li>
                    <li>7 Day Repeats IN/COS %</li>
                    <li>7 Day Repeats TC %</li>
                    <li>30 Day IN/COS Repeat %</li>
                    <li>30 Day TC Repeat %</li>
                    <li>On Time %</li>
                    <li>TS %</li>
                    <li>NPS %</li>
                    <li>SMS Text Compliance %</li>
                    <li>OSAT (as a score, not a percent)</li>
                </ul>
            </div>
             <div>
                <h4 class="font-medium text-slate-600 border-b mb-2 pb-1">Raw Data for Calculation</h4>
                <ul class="list-disc list-inside space-y-1">
                    <li>Jobs, Closed</li>
                    <li>7 Day IN/COS Repeats, 7 Day IN/COS TR's</li>
                    <li>7 Day TC Repeats, 7 Day TC TR's</li>
                    <li>30 Day IN/COS Repeats, 30 Day IN/COS Truck Rolls</li>
                    <li>30 Day TC Repeats, 30 Day TC Truck Rolls</li>
                    <li>On Time Jobs, On Time TR's</li>
                    <li>NPS Promoters, NPS Detractors, NPS Surveys</li>
                    <li>OSAT Sum, OSAT Count</li>
                    <li>Techspeed Numerator, Techspeed Denominator</li>
                    <li>SMS Compliant, SMS Total</li>
                </ul>
            </div>
        </div>
      </div>
    </div>
  </div>
}
