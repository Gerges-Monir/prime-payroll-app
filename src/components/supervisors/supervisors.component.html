<div class="animate-fade-in space-y-6">
  <div>
    <h2 class="text-xl font-semibold text-slate-800">Revenue Analysis</h2>
    <p class="text-slate-500">Analyze revenue and payouts based on finalized payroll history.</p>
  </div>

  <!-- Filters -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-100/70 p-4 rounded-lg border border-slate-200">
    <div>
      <label for="week-select" class="block text-sm font-medium text-slate-700 mb-1">Filter by Week</label>
      <select id="week-select" [(ngModel)]="selectedWeekId" class="w-full p-3 bg-white border border-slate-300 rounded-lg shadow-sm">
        <option value="all">All Weeks (YTD)</option>
        @for (payroll of payrolls(); track payroll.id) {
          <option [value]="payroll.id">{{ payroll.startDate | date:'mediumDate' }} - {{ payroll.endDate | date:'mediumDate' }}</option>
        }
      </select>
    </div>
    <div>
      <label for="tech-select" class="block text-sm font-medium text-slate-700 mb-1">Filter by Technician</label>
      <select id="tech-select" [(ngModel)]="selectedTechId" class="w-full p-3 bg-white border border-slate-300 rounded-lg shadow-sm">
        <option value="all">All Technicians</option>
        @for (tech of technicians(); track tech.id) {
          <option [value]="tech.id">{{ tech.name }}</option>
        }
      </select>
    </div>
  </div>

  <!-- Stat Cards -->
  @if (analysisData(); as data) {
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
        <p class="text-sm font-medium text-slate-500">Total Company Revenue</p>
        <p class="text-3xl font-bold text-blue-600 mt-1">{{ data.totalCompanyRevenue | currency }}</p>
        <p class="text-xs text-slate-400 mt-1">Gross Revenue - Total Payout</p>
      </div>
      <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
        <p class="text-sm font-medium text-slate-500">Total Technician Payout</p>
        <p class="text-3xl font-bold text-green-600 mt-1">{{ data.totalTechPayout | currency }}</p>
         <p class="text-xs text-slate-400 mt-1">Sum of all finalized salaries</p>
      </div>
      <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
        <p class="text-sm font-medium text-slate-500">Total Gross Revenue</p>
        <p class="text-3xl font-bold text-slate-800 mt-1">{{ data.totalGrossRevenue | currency }}</p>
        <p class="text-xs text-slate-400 mt-1">Sum of all job revenues</p>
      </div>
    </div>

    <!-- Table -->
    <div class="border border-slate-200 rounded-lg">
      <div class="max-h-[60vh] overflow-y-auto">
        <table class="w-full text-left">
          <thead class="sticky top-0 bg-slate-100 z-10">
            <tr>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500">Technician</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500 text-right">Revenue Generated</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500 text-right">Payout (Salary)</th>
              <th class="p-4 text-sm font-semibold uppercase text-slate-500 text-right">Company Revenue</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
            @for (tech of data.techBreakdown; track tech.id) {
              <tr class="hover:bg-slate-50">
                <td class="p-4 font-medium text-slate-800">{{ tech.name }}</td>
                <td class="p-4 text-right font-mono text-slate-800">{{ tech.totalRevenue | currency }}</td>
                <td class="p-4 text-right font-mono text-green-600">{{ tech.totalPayout | currency }}</td>
                <td class="p-4 text-right font-mono font-bold" [class.text-blue-600]="tech.companyRevenue >= 0" [class.text-red-600]="tech.companyRevenue < 0">
                  {{ tech.companyRevenue | currency }}
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="4" class="text-center text-slate-500 py-16">
                  <p>No data available for the selected filters.</p>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  } @else {
    <div class="text-center py-20 text-slate-500">
      <p>Loading analysis...</p>
    </div>
  }
</div>
