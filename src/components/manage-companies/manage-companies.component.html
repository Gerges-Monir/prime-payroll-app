<div class="animate-fade-in">
  <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
    <div>
      <h2 class="text-xl font-semibold text-slate-800">Manage Companies</h2>
      <p class="text-slate-500">Configure subcontractor companies, assign their payout rates, and manage their teams.</p>
    </div>
    <div class="w-full md:w-1/3">
      <select (change)="selectSubAdmin($event)" class="bg-slate-50 text-slate-800 p-3 rounded-md w-full border border-slate-300 focus:ring-2 focus:ring-blue-500/50 outline-none shadow-sm">
        <option value="">Select a Sub-Admin...</option>
        @for(subAdmin of subAdmins(); track subAdmin.id) {
          <option [value]="subAdmin.id">{{ subAdmin.name }}</option>
        }
      </select>
    </div>
  </div>

  @if (selectedSubAdmin(); as subAdmin) {
    <div class="space-y-8">
      <!-- Company Settings -->
      <form [formGroup]="companySettingsForm" (ngSubmit)="saveCompanySettings()" class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
            <h3 class="text-lg font-semibold text-slate-800">Company Settings for {{subAdmin.name}}</h3>
            <button type="submit" [disabled]="companySettingsForm.invalid || isSaving()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm disabled:bg-slate-300 disabled:cursor-not-allowed">
              {{ isSaving() ? 'Saving...' : 'Save Settings' }}
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="companyName" class="block text-sm font-medium text-slate-500 mb-1">Company Name</label>
            <input id="companyName" formControlName="companyName" placeholder="e.g., Optiwave" class="bg-slate-50 text-slate-800 p-2 rounded-md w-full border border-slate-300">
          </div>
          <div>
            <label for="rateCategoryId" class="block text-sm font-medium text-slate-500 mb-1">Company Rate Category</label>
            <select id="rateCategoryId" formControlName="rateCategoryId" class="bg-slate-50 text-slate-800 p-2 rounded-md w-full border border-slate-300">
              <option [ngValue]="null">Select a category...</option>
              @for(cat of rateCategories(); track cat.id) {
                <option [value]="cat.id">{{ cat.name }}</option>
              }
            </select>
          </div>
          <div>
            <label for="profitShare" class="block text-sm font-medium text-slate-500 mb-1">Profit Share (%)</label>
            <input id="profitShare" formControlName="profitShare" type="number" class="bg-slate-50 text-slate-800 p-2 rounded-md w-full border border-slate-300">
          </div>
        </div>
      </form>

      <!-- Employee Management -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Unassigned Employees -->
        <div>
          <h3 class="text-lg font-semibold mb-4 text-slate-800">Unassigned Employees</h3>
          <div class="bg-slate-100/50 p-4 rounded-lg space-y-3 min-h-[400px] border border-slate-200 shadow-inner">
            @for(employee of unassignedEmployees(); track employee.id) {
              <div class="bg-white p-3 rounded-lg flex justify-between items-center group border border-slate-200 shadow-sm">
                <div>
                  <p class="font-semibold text-slate-800">{{ employee.name }}</p>
                  <p class="text-sm text-slate-500">#{{ employee.techId }}</p>
                </div>
                <button (click)="assign(employee.id)" class="bg-blue-600/10 text-blue-600 px-3 py-1 rounded-md text-sm font-semibold transition-all hover:bg-blue-600/20 flex items-center gap-1">
                  Assign <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                </button>
              </div>
            } @empty {
              <div class="text-center text-slate-500 pt-16">
                <p>All employees are assigned.</p>
              </div>
            }
          </div>
        </div>
        <!-- Assigned Employees -->
        <div>
          <h3 class="text-lg font-semibold mb-4 text-slate-800">Assigned to {{ subAdmin.name }}'s Team</h3>
          <div class="bg-slate-100/50 p-4 rounded-lg space-y-3 min-h-[400px] border border-slate-200 shadow-inner">
            @for(employee of assignedEmployees(); track employee.id) {
              <div class="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                <div class="flex justify-between items-center group">
                  <div>
                    <p class="font-semibold text-slate-800">{{ employee.name }}</p>
                    <p class="text-sm text-slate-500">#{{ employee.techId }}</p>
                  </div>
                  <button (click)="unassign(employee.id)" class="bg-red-600/10 text-red-600 px-3 py-1 rounded-md text-sm font-semibold transition-all hover:bg-red-600 hover:text-white flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg> Unassign
                  </button>
                </div>
                <div class="mt-3 pt-3 border-t">
                    <label for="emp-rate-{{employee.id}}" class="block text-xs font-medium text-slate-500 mb-1">Payout Rate Category</label>
                    <select id="emp-rate-{{employee.id}}" [value]="employee.rateCategoryId || ''" (change)="updateEmployeeRateCategory(employee.id, $event)" class="w-full p-2 text-sm bg-slate-50 border border-slate-300 rounded-md">
                        <option value="">-- Inherit from Company --</option>
                         @for(cat of rateCategories(); track cat.id) {
                            <option [value]="cat.id">{{ cat.name }}</option>
                        }
                    </select>
                </div>
              </div>
            } @empty {
               <div class="text-center text-slate-500 pt-16">
                <p>No employees assigned yet.</p>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  } @else {
    <div class="text-center py-20 text-slate-500 bg-slate-100/70 rounded-lg border-2 border-dashed border-slate-200">
      <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-sky-500" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.746-1.043m-2.252 2.252a8.985 8.985 0 0 1-3.642 1.5a8.985 8.985 0 0 1-3.642-1.5m6.53-4.53-3.25-3.25m0 0-3.25 3.25M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18Z" /></svg>
      <h2 class="text-2xl font-bold text-slate-800 mt-4">Select a Sub-Admin</h2>
      <p class="mt-2 text-lg">Choose a sub-admin from the dropdown to manage their company settings and team.</p>
    </div>
  }
</div>