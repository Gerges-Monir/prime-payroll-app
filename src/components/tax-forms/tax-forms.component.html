<div class="animate-fade-in space-y-6">
  <div>
    <h2 class="text-xl font-semibold text-slate-800">1099-NEC Tax Forms</h2>
    <p class="text-slate-500">Generate and download 1099-NEC forms for year-to-date compensation.</p>
  </div>

  <!-- Controls based on user role -->
  <div class="p-4 bg-slate-100/70 rounded-lg border border-slate-200">
    @switch (currentUser()?.role) {
      @case ('admin') {
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="user-select" class="block text-sm font-medium text-slate-700 mb-1">Select User</label>
            <select id="user-select" [ngModel]="selectedUserIdForAdmin()" (ngModelChange)="selectedUserIdForAdmin.set($event)" class="w-full p-2 bg-white border border-slate-300 rounded-md">
              @for (user of allUsersForDropdown(); track user.id) {
                <option [value]="user.id">{{ user.name }} ({{user.role}})</option>
              }
            </select>
          </div>
          <div>
            <label for="year-select" class="block text-sm font-medium text-slate-700 mb-1">Tax Year</label>
            <select id="year-select" [ngModel]="selectedYear()" (ngModelChange)="selectedYear.set(+$event)" class="w-full p-2 bg-white border border-slate-300 rounded-md">
              @for (year of availableYears; track year) {
                <option [value]="year">{{ year }}</option>
              }
            </select>
          </div>
        </div>
      }
      @case ('supervisor') {
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="view-mode" class="block text-sm font-medium text-slate-700 mb-1">View Mode</label>
            <div class="flex items-center gap-2 p-1 bg-slate-200 rounded-lg w-fit">
              <button (click)="viewModeForTeam.set('personal')" [class]="viewModeForTeam() === 'personal' ? 'bg-white shadow' : ''" class="px-3 py-1 text-sm font-semibold rounded-md">Personal</button>
              <button (click)="viewModeForTeam.set('company')" [class]="viewModeForTeam() === 'company' ? 'bg-white shadow' : ''" class="px-3 py-1 text-sm font-semibold rounded-md">Company</button>
            </div>
          </div>
           <div>
            <label for="year-select-team" class="block text-sm font-medium text-slate-700 mb-1">Tax Year</label>
            <select id="year-select-team" [ngModel]="selectedYear()" (ngModelChange)="selectedYear.set(+$event)" class="w-full p-2 bg-white border border-slate-300 rounded-md">
              @for (year of availableYears; track year) {
                <option [value]="year">{{ year }}</option>
              }
            </select>
          </div>
        </div>
      }
      @case ('sub-admin') {
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="view-mode" class="block text-sm font-medium text-slate-700 mb-1">View Mode</label>
            <div class="flex items-center gap-2 p-1 bg-slate-200 rounded-lg w-fit">
              <button (click)="viewModeForTeam.set('personal')" [class]="viewModeForTeam() === 'personal' ? 'bg-white shadow' : ''" class="px-3 py-1 text-sm font-semibold rounded-md">Personal</button>
              <button (click)="viewModeForTeam.set('company')" [class]="viewModeForTeam() === 'company' ? 'bg-white shadow' : ''" class="px-3 py-1 text-sm font-semibold rounded-md">Company</button>
            </div>
          </div>
           <div>
            <label for="year-select-team-sub" class="block text-sm font-medium text-slate-700 mb-1">Tax Year</label>
            <select id="year-select-team-sub" [ngModel]="selectedYear()" (ngModelChange)="selectedYear.set(+$event)" class="w-full p-2 bg-white border border-slate-300 rounded-md">
              @for (year of availableYears; track year) {
                <option [value]="year">{{ year }}</option>
              }
            </select>
          </div>
        </div>
      }
      @case('employee') {
         <div>
            <label for="year-select-emp" class="block text-sm font-medium text-slate-700 mb-1">Tax Year</label>
            <select id="year-select-emp" [ngModel]="selectedYear()" (ngModelChange)="selectedYear.set(+$event)" class="w-full md:w-1/2 p-2 bg-white border border-slate-300 rounded-md">
              @for (year of availableYears; track year) {
                <option [value]="year">{{ year }}</option>
              }
            </select>
          </div>
      }
    }
  </div>

  <!-- 1099 Form Display -->
  @if (recipientInfo(); as recipient) {
    <app-form-1099 
      [payer]="payerInfo()" 
      [recipient]="recipient" 
      [compensation]="compensation()"
      [year]="selectedYear()"
      (detailsClicked)="showDetailsModal.set(true)">
    </app-form-1099>
  } @else {
    <div class="text-center py-20 text-slate-500">
      <p>Select a user to generate their 1099 form.</p>
    </div>
  }

</div>

<!-- Payment Details Modal -->
@if (showDetailsModal() && recipientInfo(); as recipient) {
  <div class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in p-4" (click)="showDetailsModal.set(false)">
    <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-2xl border border-slate-200 max-h-[90vh] flex flex-col" (click)="$event.stopPropagation()">
      <div class="flex justify-between items-center mb-4 flex-shrink-0">
          <h2 class="text-2xl font-bold text-slate-800">Payment Details for {{ recipient.name }} - {{ selectedYear() }}</h2>
          <button (click)="showDetailsModal.set(false)" class="text-slate-500 hover:text-slate-800">&times;</button>
      </div>
      <div class="flex-grow overflow-y-auto border-t border-b border-slate-200 py-4">
        <table class="w-full text-left">
          <thead class="sticky top-0 bg-slate-100 z-10">
            <tr>
              <th class="p-3 text-sm font-semibold uppercase text-slate-500">Pay Period / Item</th>
              <th class="p-3 text-sm font-semibold uppercase text-slate-500 text-right">Amount Paid</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
            @for (payment of paymentDetails(); track payment.id) {
              <tr class="hover:bg-blue-50/70">
                <td class="p-3 text-slate-800">{{ payment.week }}</td>
                <td class="p-3 font-mono text-right text-slate-800">{{ payment.amount | currency }}</td>
              </tr>
            } @empty {
              <tr>
                <td colspan="2" class="text-center p-8 text-slate-500">No payments found for this year.</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
       <div class="flex justify-between items-center mt-4 pt-4 border-t border-slate-200 flex-shrink-0">
          <span class="text-lg font-bold text-slate-800">Total</span>
          <span class="text-xl font-bold text-green-600">{{ compensation() | currency }}</span>
       </div>
    </div>
  </div>
}