<div class="animate-fade-in">
  <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
    <div>
      <h2 class="text-2xl font-bold">üîß Manage Jobs</h2>
      <p class="text-gray-400">View, edit, or delete individual job records.</p>
    </div>
    <input 
      type="text" 
      placeholder="üîç Search by tech name, ID, or task..."
      (input)="onFilter($event)"
      class="bg-gray-800 text-white p-3 rounded-md w-full md:w-1/3 border border-gray-700 focus:ring-2 focus:ring-brand-info outline-none">
  </div>

  <div class="bg-gray-800 p-2 rounded-lg">
    <div class="max-h-[600px] overflow-y-auto">
      <table class="w-full text-left">
        <thead class="sticky top-0 bg-gray-900 z-10">
          <tr>
            <th class="p-4 text-sm font-semibold uppercase text-gray-400 cursor-pointer" (click)="setSort('techName')">
              Technician <span class="text-xs">{{ sortField() === 'techName' ? (sortDirection() === 'asc' ? '‚ñ≤' : '‚ñº') : '' }}</span>
            </th>
            <th class="p-4 text-sm font-semibold uppercase text-gray-400 cursor-pointer" (click)="setSort('date')">
              Date <span class="text-xs">{{ sortField() === 'date' ? (sortDirection() === 'asc' ? '‚ñ≤' : '‚ñº') : '' }}</span>
            </th>
            <th class="p-4 text-sm font-semibold uppercase text-gray-400 cursor-pointer" (click)="setSort('taskCode')">
              Task Code <span class="text-xs">{{ sortField() === 'taskCode' ? (sortDirection() === 'asc' ? '‚ñ≤' : '‚ñº') : '' }}</span>
            </th>
            <th class="p-4 text-sm font-semibold uppercase text-gray-400 text-right cursor-pointer" (click)="setSort('quantity')">
              Qty <span class="text-xs">{{ sortField() === 'quantity' ? (sortDirection() === 'asc' ? '‚ñ≤' : '‚ñº') : '' }}</span>
            </th>
            <th class="p-4 text-sm font-semibold uppercase text-gray-400 text-right cursor-pointer" (click)="setSort('revenue')">
              Revenue <span class="text-xs">{{ sortField() === 'revenue' ? (sortDirection() === 'asc' ? '‚ñ≤' : '‚ñº') : '' }}</span>
            </th>
            <th class="p-4 text-sm font-semibold uppercase text-gray-400 text-center">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-700">
          @for (job of filteredAndSortedJobs(); track job.id) {
            <tr class="hover:bg-gray-700 group">
              <td class="p-4">
                <p class="font-medium text-white">{{ job.techName }}</p>
                <p class="text-sm text-gray-400">#{{ job.techId }}</p>
              </td>
              <td class="p-4 text-gray-300">{{ job.date | date:'shortDate' }}</td>
              <td class="p-4 text-gray-300">{{ job.taskCode }}</td>
              <td class="p-4 font-mono text-right text-white">{{ job.quantity }}</td>
              <td class="p-4 font-mono text-right text-white">{{ job.revenue | currency }}</td>
              <td class="p-4 text-center">
                <div class="opacity-0 group-hover:opacity-100 transition-opacity flex justify-center gap-2">
                   <button (click)="openEditJobModal(job)" class="bg-brand-info hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md text-sm">Edit</button>
                   <button (click)="deleteJob(job.id, $event)" class="bg-brand-accent hover:bg-red-700 text-white font-bold py-1 px-3 rounded-md text-sm">Delete</button>
                </div>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="6" class="text-center text-gray-500 py-16">
                 <div class="text-5xl">üìù</div>
                <h3 class="mt-4 text-xl font-semibold">No Jobs Found</h3>
                <p class="mt-1">Upload a job file or clear your search filter.</p>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit Job Modal -->
@if (showJobModal()) {
  <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 animate-fade-in">
    <div class="bg-brand-secondary rounded-lg shadow-2xl p-8 w-full max-w-md m-4">
      <h2 class="text-2xl font-bold mb-6 text-white">Edit Job for {{ userMap().get(jobToEdit()?.techId || '') }}</h2>
      <form [formGroup]="jobForm" (ngSubmit)="saveJob()">
        <div class="space-y-4">
            <input formControlName="date" type="date" class="bg-gray-800 text-white p-3 rounded-md w-full border border-gray-700 focus:ring-2 focus:ring-brand-info outline-none">
            <input formControlName="taskCode" placeholder="Task Code" class="bg-gray-800 text-white p-3 rounded-md w-full border border-gray-700 focus:ring-2 focus:ring-brand-info outline-none">
            <input formControlName="quantity" type="number" placeholder="Quantity" class="bg-gray-800 text-white p-3 rounded-md w-full border border-gray-700 focus:ring-2 focus:ring-brand-info outline-none">
            <input formControlName="revenue" type="number" step="0.01" placeholder="Revenue" class="bg-gray-800 text-white p-3 rounded-md w-full border border-gray-700 focus:ring-2 focus:ring-brand-info outline-none">
        </div>
        <div class="flex justify-end gap-4 mt-8">
          <button type="button" (click)="closeJobModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancel</button>
          <button type="submit" [disabled]="jobForm.invalid" class="bg-brand-success hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg disabled:bg-gray-500 disabled:cursor-not-allowed">Save Job</button>
        </div>
      </form>
    </div>
  </div>
}