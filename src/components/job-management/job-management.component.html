<div class="animate-fade-in">
  <div>
    <h2 class="text-xl font-semibold text-brand-text-primary">Manage Jobs</h2>
    <p class="text-brand-text-secondary">View, edit, or delete individual job records.</p>
  </div>
  
  <!-- Filters -->
  <div class="my-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
    <div class="lg:col-span-2">
      <label class="block text-sm font-medium text-brand-text-secondary mb-1">Search</label>
      <input 
        type="text" 
        placeholder="Search by tech name, ID, or task..."
        (input)="onFilter($event)"
        class="bg-brand-input-bg text-brand-text-primary p-3 rounded-md w-full border border-brand-border focus:ring-2 focus:ring-brand-primary/50 outline-none">
    </div>
     <div>
      <label class="block text-sm font-medium text-brand-text-secondary mb-1">Start Date</label>
      <input type="date" [value]="startDate() || ''" (input)="onStartDate($event)" class="bg-brand-input-bg text-brand-text-primary p-3 rounded-md w-full border border-brand-border focus:ring-2 focus:ring-brand-primary/50 outline-none">
    </div>
    <div>
      <label class="block text-sm font-medium text-brand-text-secondary mb-1">End Date</label>
      <input type="date" [value]="endDate() || ''" (input)="onEndDate($event)" class="bg-brand-input-bg text-brand-text-primary p-3 rounded-md w-full border border-brand-border focus:ring-2 focus:ring-brand-primary/50 outline-none">
    </div>
  </div>
  <div class="flex items-center gap-2 mb-6">
      <span class="text-sm font-medium text-brand-text-secondary">Quick Filters:</span>
      <button (click)="setQuickFilter('today')" class="text-sm bg-slate-200 hover:bg-slate-300 text-brand-text-primary font-semibold px-3 py-1 rounded-full">Today</button>
      <button (click)="setQuickFilter('week')" class="text-sm bg-slate-200 hover:bg-slate-300 text-brand-text-primary font-semibold px-3 py-1 rounded-full">This Week</button>
      <button (click)="setQuickFilter('month')" class="text-sm bg-slate-200 hover:bg-slate-300 text-brand-text-primary font-semibold px-3 py-1 rounded-full">This Month</button>
  </div>


  <div class="border border-brand-border rounded-lg">
    <div class="max-h-[600px] overflow-y-auto">
      <table class="w-full text-left">
        <thead class="sticky top-0 bg-slate-50 z-10 border-b border-brand-border">
          <tr>
            <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary tracking-wider cursor-pointer" (click)="setSort('techName')">
              Technician <span class="text-xs">{{ sortField() === 'techName' ? (sortDirection() === 'asc' ? '▲' : '▼') : '' }}</span>
            </th>
            <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary tracking-wider cursor-pointer" (click)="setSort('date')">
              Date <span class="text-xs">{{ sortField() === 'date' ? (sortDirection() === 'asc' ? '▲' : '▼') : '' }}</span>
            </th>
            <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary tracking-wider cursor-pointer" (click)="setSort('taskCode')">
              Task Code <span class="text-xs">{{ sortField() === 'taskCode' ? (sortDirection() === 'asc' ? '▲' : '▼') : '' }}</span>
            </th>
            <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary tracking-wider text-right cursor-pointer" (click)="setSort('quantity')">
              Qty <span class="text-xs">{{ sortField() === 'quantity' ? (sortDirection() === 'asc' ? '▲' : '▼') : '' }}</span>
            </th>
            <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary tracking-wider text-right cursor-pointer" (click)="setSort('revenue')">
              Revenue <span class="text-xs">{{ sortField() === 'revenue' ? (sortDirection() === 'asc' ? '▲' : '▼') : '' }}</span>
            </th>
            <th class="p-4 text-sm font-semibold uppercase text-brand-text-secondary tracking-wider text-center">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-brand-border">
          @for (job of filteredAndSortedJobs(); track job.id) {
            <tr class="hover:bg-slate-50/70 group">
              <td class="p-4" (click)="openEditJobModal(job)">
                <p class="font-medium text-brand-text-primary">{{ job.techName }}</p>
                <p class="text-sm text-brand-text-secondary">#{{ job.techId }}</p>
              </td>
              <td class="p-4 text-brand-text-primary" (click)="openEditJobModal(job)">{{ job.date | date:'shortDate' }}</td>
              <td class="p-4 text-brand-text-primary" (click)="openEditJobModal(job)">{{ job.taskCode }}</td>
              <td class="p-4 font-mono text-right text-brand-text-primary" (click)="openEditJobModal(job)">{{ job.quantity }}</td>
              <td class="p-4 font-mono text-right text-brand-text-primary" (click)="openEditJobModal(job)">{{ job.revenue | currency }}</td>
              <td class="p-4 text-center">
                <div class="flex justify-center gap-2">
                   <button (click)="deleteJob(job.id)" class="bg-white border border-red-300 text-red-600 hover:bg-red-50 font-bold py-1 px-3 rounded-md text-sm">Delete</button>
                </div>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="6" class="text-center text-brand-text-secondary py-16">
                 <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-slate-400" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" /></svg>
                <h3 class="mt-4 text-xl font-semibold text-brand-text-primary">No Jobs Found</h3>
                <p class="mt-1">No jobs match your current filters. Try adjusting your search or date range.</p>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit Job Modal -->
@if (showJobModal()) {
  <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 animate-fade-in p-4">
    <div class="bg-brand-surface rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-md m-4 border border-brand-border">
      <h2 class="text-2xl font-bold mb-6 text-brand-text-primary">Edit Job for {{ userMap().get(jobToEdit()?.techId || '') }}</h2>
      <form [formGroup]="jobForm" (ngSubmit)="saveJob()">
        <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-brand-text-primary mb-1.5">Date</label>
              <input formControlName="date" type="date" class="bg-brand-input-bg text-brand-text-primary p-3 rounded-md w-full border border-brand-border focus:ring-2 focus:ring-brand-primary/50 outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-brand-text-primary mb-1.5">Task Code</label>
              <input formControlName="taskCode" placeholder="Task Code" class="bg-brand-input-bg text-brand-text-primary p-3 rounded-md w-full border border-brand-border focus:ring-2 focus:ring-brand-primary/50 outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-brand-text-primary mb-1.5">Quantity</label>
              <input formControlName="quantity" type="number" placeholder="Quantity" class="bg-brand-input-bg text-brand-text-primary p-3 rounded-md w-full border border-brand-border focus:ring-2 focus:ring-brand-primary/50 outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-brand-text-primary mb-1.5">Revenue</label>
              <input formControlName="revenue" type="number" step="0.01" placeholder="Revenue" class="bg-brand-input-bg text-brand-text-primary p-3 rounded-md w-full border border-brand-border focus:ring-2 focus:ring-brand-primary/50 outline-none">
            </div>
        </div>
        <div class="flex justify-end gap-4 mt-8">
          <button type="button" (click)="closeJobModal()" class="bg-white hover:bg-slate-100 text-brand-text-secondary border border-brand-border font-bold py-2 px-6 rounded-lg">Cancel</button>
          <button type="submit" [disabled]="jobForm.invalid || isSavingJob()" class="bg-brand-primary hover:bg-brand-primary-hover text-brand-text-on-primary font-bold py-2 px-6 rounded-lg disabled:bg-slate-400 disabled:cursor-not-allowed">Save Job</button>
        </div>
      </form>
    </div>
  </div>
}